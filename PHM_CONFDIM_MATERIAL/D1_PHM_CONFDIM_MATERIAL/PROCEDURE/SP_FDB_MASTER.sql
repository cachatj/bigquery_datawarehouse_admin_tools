CREATE PROCEDURE `PROJECT_ID`.D1_PHM_CONFDIM_MATERIAL.SP_FDB_MASTER()
BEGIN

/***********************************************************************************************************************
Author: Gopalakrishnan Thangavel
Creation Date: 05/15/2023
Data Sources: VI2_PHM_CONFDIM_MATERIAL.PHM_EDA_FDB__FDB_MASTER_CV

*************************************************************************
Change History		[DATE]			[CHANGED BY]	[JIRA#]		[CODE REVIEW BY]		[DESCRIPTION]
	<#>					<MM/DD/YYYY>	<Name>			<ID>

************************************************************************************************************************/

DECLARE v_start_time datetime;
DECLARE v_start_stp timestamp;
DECLARE v_end_stp timestamp;
DECLARE v_stored_proc_name string;

SET v_start_time = current_datetime();
SET v_start_stp = CURRENT_TIMESTAMP;
SET v_end_stp = (SELECT CAST('9999-12-31 23:59:59' AS TIMESTAMP));
SET v_stored_proc_name = 'D1_PHM_CONFDIM_MATERIAL.SP_FDB_MASTER';

--flush the data and insert
TRUNCATE TABLE `PROJECT_ID.D1_PHM_CONFDIM_MATERIAL.FDB_MASTER_CV`;

--Create Temp table to get the data
CREATE OR REPLACE TEMPORARY TABLE FDB_TEMP
AS
SELECT
  FDB_MASTER.NDC,
  FDB_MASTER.LBLRID,
  FDB_MASTER.GCN_SEQNO,
  FDB_MASTER.PS,
  FDB_MASTER.DF,
  FDB_MASTER.AD,
  FDB_MASTER.LN,
  FDB_MASTER.BN,
  FDB_MASTER.PNDC,
  FDB_MASTER.REPNDC,
  FDB_MASTER.NDCFI,
  FDB_MASTER.DADDNC,
  FDB_MASTER.DUPDC,
  FDB_MASTER.DESI,
  FDB_MASTER.DESDTEC,
  FDB_MASTER.DESI2,
  FDB_MASTER.DES2DTEC,
  FDB_MASTER.DEA,
  FDB_MASTER.CL,
  FDB_MASTER.GPI,
  FDB_MASTER.HOSP,
  FDB_MASTER.INNOV,
  FDB_MASTER.IPI,
  FDB_MASTER.MINI,
  FDB_MASTER.MAINT,
  FDB_MASTER.OBC,
  FDB_MASTER.OBSDTEC,
  FDB_MASTER.PPI,
  FDB_MASTER.STPK,
  FDB_MASTER.REPACK,
  FDB_MASTER.TOP200,
  FDB_MASTER.UD,
  FDB_MASTER.CSP,
  FDB_MASTER.NDL_GDGE,
  FDB_MASTER.NDL_LNGTH,
  FDB_MASTER.SYR_CPCTY,
  FDB_MASTER.SHLF_PCK,
  FDB_MASTER.SHIPPER,
  FDB_MASTER.HCFA_FDA,
  FDB_MASTER.HCFA_UNIT,
  FDB_MASTER.HCFA_PS,
  FDB_MASTER.HCFA_APPC,
  FDB_MASTER.HCFA_MRKC,
  FDB_MASTER.HCFA_TRMC,
  FDB_MASTER.HCFA_TYP,
  FDB_MASTER.HCFA_DESC1,
  FDB_MASTER.HCFA_DESI1,
  FDB_MASTER.UU,
  FDB_MASTER.PD,
  FDB_MASTER.LN25,
  FDB_MASTER.LN25I,
  FDB_MASTER.GPIDC,
  FDB_MASTER.BBDC,
  FDB_MASTER.HOME,
  FDB_MASTER.INPCKI,
  FDB_MASTER.OUTPCKI,
  FDB_MASTER.OBC_EXP,
  FDB_MASTER.PS_EQUIV,
  FDB_MASTER.PLBLR,
  FDB_MASTER.TOP50GEN,
  FDB_MASTER.GMI,
  FDB_MASTER.GNI,
  FDB_MASTER.GSI,
  FDB_MASTER.GTI,
  FDB_MASTER.NDCGI1,
  FDB_MASTER.HCFA_DC,
  FDB_MASTER.LN60,
  FDB_MASTER.HICL_SEQNO,
  FDB_MASTER.GCDF,
  FDB_MASTER.GCRT,
  FDB_MASTER.STR,
  FDB_MASTER.GTC,
  FDB_MASTER.TC,
  FDB_MASTER.DCC,
  FDB_MASTER.GCNSEQ_GI,
  FDB_MASTER.GENDER,
  FDB_MASTER.HIC3_SEQN,
  FDB_MASTER.STR60,
  FDB_MASTER.RT,
  FDB_MASTER.GCRT2,
  FDB_MASTER.GCRT_DESC,
  FDB_MASTER.SYSTEMIC,
  FDB_MASTER.MFG,
  FDB_MASTER.LBLRIND,
  FDB_MASTER.COLOR_TXT,
  FDB_MASTER.SHAPE_TXT,
  FDB_MASTER.FLAVOR_TXT,
  FDB_MASTER.CHG_FLAG,
  FDB_MASTER.NDA_IND,
  FDB_MASTER.ANDA_IND,
  FDB_MASTER.LISTING_SEQ_NO,
  FDB_MASTER.TRADENAME,
  FDB_MASTER.DOSE,
  FDB_MASTER.GCDF_DESC,
  FDB_MASTER.STRNUM,
  FDB_MASTER.VOLNUM,
  FDB_MASTER.STRUN50,
  FDB_MASTER.VOLUN50,
  FDB_MASTER.OBC_GCN,
  FDB_MASTER.GNN,
  FDB_MASTER.GNN60,
  FDB_MASTER.AHFS8,
  FDB_MASTER.AHFS_DESC,
  FDB_MASTER.GCN,
  FDB_MASTER.DCC_DESC,
  FDB_MASTER.GTC_DESC,
  FDB_MASTER.HIC3,
  FDB_MASTER.HIC3_DESC,
  FDB_MASTER.HIC3_GRPN,
  FDB_MASTER.HIC3_ROOT,
  FDB_MASTER.OBC_SN,
  FDB_MASTER.OBC_DESC,
  FDB_MASTER.MEDID,
  FDB_MASTER.TM_SOURCE_ID,
  FDB_MASTER.TM_IND,
  FDB_MASTER.TM_ALT_MEDID_DESC,
  FDB_MASTER.TC_DESC,
  FDB_MASTER.AMP_PRICE_EFFECTIVE_DATE,
  FDB_MASTER.AMP_PRICE,
  FDB_MASTER.HCPC,
  FDB_MASTER.HCPC_PBC1,
  FDB_MASTER.HCPC_PBP1,
  FDB_MASTER.HCPC_PBC2,
  FDB_MASTER.HCPC_PBP2,
  FDB_MASTER.HCPC_PBC3,
  FDB_MASTER.HCPC_PBP3,
  FDB_MASTER.HCPC_PBC4,
  FDB_MASTER.HCPC_PBP4,
  FDB_MASTER.HCPC_PBC5,
  FDB_MASTER.HCPC_PBP5,
  FDB_MASTER.HCPC_PBC6,
  FDB_MASTER.HCPC_PBP6,
  FDB_MASTER.HCPC_PBC7,
  FDB_MASTER.HCPC_PBP7,
  FDB_MASTER.HCPC_PBC8,
  FDB_MASTER.HCPC_PBP8,
  FDB_MASTER.MCR_BCDESC,
  FDB_MASTER.OBC3,
  RANK() OVER(PARTITION BY FDB_MASTER.NDC ORDER BY FDB_MASTER.AUDIT.EVENTTIME DESC) AS RANK_RN
 FROM `PROJECT_ID.VI2_PHM_CONFDIM_MATERIAL.PHM_EDA_FDB__FDB_MASTER_CV`
;

INSERT INTO `PROJECT_ID.D1_PHM_CONFDIM_MATERIAL.FDB_MASTER_CV`
SELECT
  NDC,
  LBLRID,
  GCN_SEQNO,
  PS,
  DF,
  AD,
  LN,
  BN,
  PNDC,
  REPNDC,
  NDCFI,
  DADDNC,
  DUPDC,
  DESI,
  DESDTEC,
  DESI2,
  DES2DTEC,
  DEA,
  CL,
  GPI,
  HOSP,
  INNOV,
  IPI,
  MINI,
  MAINT,
  OBC,
  OBSDTEC,
  PPI,
  STPK,
  REPACK,
  TOP200,
  UD,
  CSP,
  NDL_GDGE,
  NDL_LNGTH,
  SYR_CPCTY,
  SHLF_PCK,
  SHIPPER,
  HCFA_FDA,
  HCFA_UNIT,
  HCFA_PS,
  HCFA_APPC,
  HCFA_MRKC,
  HCFA_TRMC,
  HCFA_TYP,
  HCFA_DESC1,
  HCFA_DESI1,
  UU,
  PD,
  LN25,
  LN25I,
  GPIDC,
  BBDC,
  HOME,
  INPCKI,
  OUTPCKI,
  OBC_EXP,
  PS_EQUIV,
  PLBLR,
  TOP50GEN,
  GMI,
  GNI,
  GSI,
  GTI,
  NDCGI1,
  HCFA_DC,
  LN60,
  HICL_SEQNO,
  GCDF,
  GCRT,
  STR,
  GTC,
  TC,
  DCC,
  GCNSEQ_GI,
  GENDER,
  HIC3_SEQN,
  STR60,
  RT,
  GCRT2,
  GCRT_DESC,
  SYSTEMIC,
  MFG,
  LBLRIND,
  COLOR_TXT,
  SHAPE_TXT,
  FLAVOR_TXT,
  CHG_FLAG,
  NDA_IND,
  ANDA_IND,
  LISTING_SEQ_NO,
  TRADENAME,
  DOSE,
  GCDF_DESC,
  STRNUM,
  VOLNUM,
  STRUN50,
  VOLUN50,
  OBC_GCN,
  GNN,
  GNN60,
  AHFS8,
  AHFS_DESC,
  GCN,
  DCC_DESC,
  GTC_DESC,
  HIC3,
  HIC3_DESC,
  HIC3_GRPN,
  HIC3_ROOT,
  OBC_SN,
  OBC_DESC,
  MEDID,
  TM_SOURCE_ID,
  TM_IND,
  TM_ALT_MEDID_DESC,
  TC_DESC,
  AMP_PRICE_EFFECTIVE_DATE,
  AMP_PRICE,
  HCPC,
  HCPC_PBC1,
  HCPC_PBP1,
  HCPC_PBC2,
  HCPC_PBP2,
  HCPC_PBC3,
  HCPC_PBP3,
  HCPC_PBC4,
  HCPC_PBP4,
  HCPC_PBC5,
  HCPC_PBP5,
  HCPC_PBC6,
  HCPC_PBP6,
  HCPC_PBC7,
  HCPC_PBP7,
  HCPC_PBC8,
  HCPC_PBP8,
  MCR_BCDESC,
  OBC3,
  v_start_stp AS ROW_ADD_STP,
	v_stored_proc_name AS ROW_ADD_USER_ID,
	v_start_stp AS ROW_UPDATE_STP,
	v_stored_proc_name AS ROW_UPDATE_USER_ID

FROM FDB_TEMP
WHERE RANK_RN = 1
;

END;