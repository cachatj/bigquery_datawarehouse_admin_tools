CREATE PROCEDURE `PROJECT_ID`.D2_PHM_CONFFACT_PRICING.SP_CREATE_PHM_EXTRACT_TEMP_1()
BEGIN
/*******************************************************************************************************************************************

Name: Shaik, Shareef
Date: Fe 22, 2024ca
Project: GPSC Iteration 2
Description: Create temp table;
Marker :
--------------------------------------------------------------------------------------------------
********************************************************************************************************************************************************/
/*
create or replace table `PROJECT_ID.D2_PHM_CONFFACT_PRICING.SEGMENT_MASTER_TEMP` as
Select distinct RLT_CV.BUY_GROUP_ID as subgroup_number, BUY_CV.BUY_GROUP_DESC_TXT as subgroup_description, 0 as group_number , BUY_CV.VRSN_START_DTE as subgroup_effective_date, BUY_CV.VRSN_END_DTE as subgroup_term_date, FORMAT_DATETIME("%m/%d/%Y",current_datetime())||' 00:00:00' as record_effective_date from `PROJECT_ID.VW_PHM_CONFDIM_CONTRACT.CONTRACT_BUYING_GROUP_RLT_CV` RLT_CV join `PROJECT_ID.VW_PHM_CONFDIM_CONTRACT.BUYING_GROUP_CV` BUY_CV on RLT_CV.BUY_GROUP_ID=BUY_CV.BUY_GROUP_ID join `PROJECT_ID.VW_PHM_CONFDIM_CONTRACT.CONTRACT_MATERIAL_DETAIL_VF` DETAIL_VF ON DETAIL_VF.CNTRCT_NUM=RLT_CV.CNTRCT_NUM where RLT_CV.CURR_VRSN_FLG='Y' and BUY_CV.CURR_VRSN_FLG ='Y' AND DETAIL_VF.CURR_VRSN_FLG ='Y' AND DETAIL_VF.VRSN_END_DTE >= CURRENT_DATE AND RLT_CV.VRSN_END_DTE >= CURRENT_DATE AND DETAIL_VF.CNTRCT_TYPE_LKP_ID = 'P' ORDER BY 1;

create or replace table `PROJECT_ID.D2_PHM_CONFFACT_PRICING.SEGMENT_DETAIL_TEMP` as
select distinct ltrim(DETAIL_VF.MTRL_NUM,'0') as corporate_item_number, GROUP_RLT_CV.BUY_GROUP_ID as subgroup_number, DETAIL_VF.VRSN_START_DTE as effective_date, DETAIL_VF.VRSN_END_DTE as term_date, FORMAT_DATETIME("%m/%d/%Y",current_datetime())||' 00:00:00' as record_effective_date from `PROJECT_ID.VW_PHM_CONFDIM_CONTRACT.CONTRACT_MATERIAL_DETAIL_VF`  DETAIL_VF join `PROJECT_ID.VW_PHM_CONFDIM_CONTRACT.CONTRACT_BUYING_GROUP_RLT_CV`  GROUP_RLT_CV on DETAIL_VF.CNTRCT_NUM=GROUP_RLT_CV.CNTRCT_NUM WHERE DETAIL_VF.CURR_VRSN_FLG='Y' AND GROUP_RLT_CV.CURR_VRSN_FLG ='Y' AND DETAIL_VF.VRSN_END_DTE >= CURRENT_DATE AND GROUP_RLT_CV.VRSN_END_DTE >= CURRENT_DATE AND DETAIL_VF.CNTRCT_TYPE_LKP_ID = 'P' ORDER BY 1;

create or replace table `PROJECT_ID.D2_PHM_CONFFACT_PRICING.SEGMENT_ATTACHMENT_TEMP` as
select distinct RIGHT(SHIP_TO.DLVR_PLANT_ID,3) as division_number, SHIP_TO.CUSTOMER_NUM as ship_to_customer_number, RLT_CV.BUY_GROUP_ID as subgroup_number, RLT_CV.VRSN_START_DTE as attachment_effective_date, RLT_CV.VRSN_END_DTE as attachment_term_date, 1+(RLT_CV.MARKUP_FCTR_PCT/100) as percent_1, 1+(RLT_CV.ADDL_MARKUP_PCT/100) as percent_2, RLT_CV.CNTRCT_RANK_PRTY_NUM as group_number, FORMAT_DATETIME("%m/%d/%Y",current_datetime())||' 00:00:00' as record_effective_date from `PROJECT_ID.VW_PHM_CONFDIM_CONTRACT.BUYING_GROUP_CUSTOMER_RLT_CV` RLT_CV JOIN `PROJECT_ID.VW_PHM_CONFDIM_CUSTOMER.CUSTOMER_CODE_CV` CUST_CODE ON CUST_CODE.CUSTOMER_NUM = RLT_CV.CUSTOMER_NUM and CUST_CODE.CUSTOMER_NUM = RLT_CV.CUSTOMER_NUM AND CUST_CODE.SALE_ORG_ID = RLT_CV.SALE_ORG_ID AND CUST_CODE.DIST_CHNL_ID = RLT_CV.DIST_CHNL_ID AND CUST_CODE.DIV_ID = RLT_CV.DIV_ID JOIN `PROJECT_ID.VW_PHM_CONFDIM_CUSTOMER.SHIPTO_CUSTOMER_SALES_AREA_RLT_CV` SHIP_TO ON SHIP_TO.SOLDTO_PARTY_CUSTOMER_NUM = RLT_CV.CUSTOMER_NUM and SHIP_TO.CURR_VRSN_FLG ='Y' AND CUST_CODE.SALE_ORG_ID = SHIP_TO.SALE_ORG_ID AND CUST_CODE.DIST_CHNL_ID = SHIP_TO.DIST_CHNL_ID AND CUST_CODE.DIV_ID = SHIP_TO.DIV_ID join `PROJECT_ID.VW_PHM_CONFDIM_CONTRACT.CONTRACT_BUYING_GROUP_RLT_CV` BUY_GROUP_RLT ON BUY_GROUP_RLT.BUY_GROUP_ID = RLT_CV.BUY_GROUP_ID and BUY_GROUP_RLT.CURR_VRSN_FLG ='Y' Join `PROJECT_ID.VW_PHM_CONFDIM_CONTRACT.CONTRACT_CV` CNT_CV ON CNT_CV.CNTRCT_NUM = BUY_GROUP_RLT.CNTRCT_NUM AND CNT_CV.CURR_VRSN_FLG ='Y' WHERE CUST_CODE.CDE_NUM_ID = '843' AND CUST_CODE.CDE_TYPE_ID ='P' AND CNT_CV.CNTRCT_TYPE_LKP_ID = 'P' and RLT_CV.VRSN_END_DTE >= CURRENT_DATE;

create or replace table `PROJECT_ID.D2_PHM_CONFFACT_PRICING.ITEM_BLOCK_TEMP` as
WITH MAT_BLK_DET AS ( SELECT SOLDTO_CUSTOMER_NUM_ID, SALE_ORG_ID, DIST_CHNL_ID, DIV_ID, BUY_GROUP_ID, '' as CNTRCT_NUM_ID, MTRL_NUM_ID, VRSN_START_DTE, VRSN_END_DTE, DEL_FLG FROM PROJECT_ID.VW_PHM_CONFFACT_PRICING.VW_CUSTOMER_BUY_GRP_MTRL_BLOCK_VF MTRL_BLK_BUY_GROUP WHERE MTRL_BLK_BUY_GROUP.CURR_VRSN_FLG ='Y' AND  MTRL_BLK_BUY_GROUP.VRSN_END_DTE >= CURRENT_DATE UNION ALL SELECT SOLDTO_CUSTOMER_NUM_ID, SALE_ORG_ID, DIST_CHNL_ID, DIV_ID, CNT_BYT_GRP_RLT.BUY_GROUP_ID AS BUY_GROUP_ID, CNTRCT_NUM_ID, MTRL_NUM_ID, MTRL_BLK_CNT_NUM.VRSN_START_DTE,MTRL_BLK_CNT_NUM.VRSN_END_DTE,MTRL_BLK_CNT_NUM.DEL_FLG  FROM PROJECT_ID.VW_PHM_CONFFACT_PRICING.VW_CUSTOMER_CNTRCT_MTRL_BLOCK_VF MTRL_BLK_CNT_NUM join `PROJECT_ID.VW_PHM_CONFDIM_CONTRACT.CONTRACT_BUYING_GROUP_RLT_CV` CNT_BYT_GRP_RLT ON MTRL_BLK_CNT_NUM.CNTRCT_NUM_ID = CNT_BYT_GRP_RLT.CNTRCT_NUM AND CNT_BYT_GRP_RLT.CURR_VRSN_FLG='Y' WHERE MTRL_BLK_CNT_NUM.CURR_VRSN_FLG ='Y' AND MTRL_BLK_CNT_NUM.VRSN_END_DTE >= CURRENT_DATE AND CNT_BYT_GRP_RLT.VRSN_END_DTE >= CURRENT_DATE ) select distinct RIGHT(SHIP_TO.DLVR_PLANT_ID,3) as division_number, SHIP_TO.CUSTOMER_NUM as ship_to_customer_number, MAT_BLK_DET.BUY_GROUP_ID as group_number, MAT_BLK_DET.MTRL_NUM_ID as corporate_item_number, CASE WHEN MAT_BLK_DET.VRSN_END_DTE >= CURRENT_DATE AND (MAT_BLK_DET.DEL_FLG = 'N' OR MAT_BLK_DET.DEL_FLG is null) then 'A' ELSE 'I' END  AS relationship_status, MAT_BLK_DET.VRSN_START_DTE as relationship_effective_date, FORMAT_DATETIME("%m/%d/%Y",current_datetime())||' 00:00:00' as record_effective_date, MAT_BLK_DET.CNTRCT_NUM_ID as Contract_Number from `PROJECT_ID.VW_PHM_CONFDIM_CUSTOMER.SHIPTO_CUSTOMER_SALES_AREA_RLT_CV` SHIP_TO JOIN MAT_BLK_DET ON SHIP_TO.SOLDTO_PARTY_CUSTOMER_NUM = MAT_BLK_DET.SOLDTO_CUSTOMER_NUM_ID and SHIP_TO.CURR_VRSN_FLG ='Y' AND MAT_BLK_DET.SALE_ORG_ID = SHIP_TO.SALE_ORG_ID AND MAT_BLK_DET.DIST_CHNL_ID = SHIP_TO.DIST_CHNL_ID AND MAT_BLK_DET.DIV_ID = SHIP_TO.DIV_ID JOIN `PROJECT_ID.VW_PHM_CONFDIM_CUSTOMER.CUSTOMER_CODE_CV` CUST_CODE ON CUST_CODE.CUSTOMER_NUM = SHIP_TO.CUSTOMER_NUM and CUST_CODE.SALE_ORG_ID = SHIP_TO.SALE_ORG_ID AND CUST_CODE.DIST_CHNL_ID = SHIP_TO.DIST_CHNL_ID AND CUST_CODE.DIV_ID = SHIP_TO.DIV_ID WHERE CUST_CODE.CDE_NUM_ID = '843' AND CUST_CODE.CDE_TYPE_ID ='P' and CUST_CODE.END_DTE >= CURRENT_DATE;

create or replace table `PROJECT_ID.D2_PHM_CONFFACT_PRICING.VENDER_BLOCK_TEMP` as
WITH VEND_BLK_DET AS ( SELECT SOLDTO_CUSTOMER_NUM_ID, SALE_ORG_ID, DIST_CHNL_ID, DIV_ID, BUY_GROUP_NUM_ID, '' as CNTRCT_NUM_ID, VENDOR_NUM_ID, VRSN_START_DTE, VRSN_END_DTE, DEL_FLG FROM PROJECT_ID.VW_PHM_CONFFACT_PRICING.VW_CUSTOMER_BUY_GRP_SUPPLIER_BLOCK_VF VEND_BLK_BUY_GROUP WHERE VEND_BLK_BUY_GROUP.CURR_VRSN_FLG ='Y' AND VEND_BLK_BUY_GROUP.VRSN_END_DTE >= CURRENT_DATE UNION ALL SELECT SOLDTO_CUSTOMER_NUM_ID, SALE_ORG_ID, DIST_CHNL_ID, DIV_ID, CNT_BYT_GRP_RLT.BUY_GROUP_ID AS BUY_GROUP_NUM_ID, CNTRCT_NUM_ID, VENDOR_NUM_ID, VEDN_BLK_CNT_NUM.VRSN_START_DTE, VEDN_BLK_CNT_NUM.VRSN_END_DTE, VEDN_BLK_CNT_NUM.DEL_FLG  FROM PROJECT_ID.VW_PHM_CONFFACT_PRICING.VW_CUSTOMER_CNTRCT_SUPPLIER_BLOCK_VF VEDN_BLK_CNT_NUM join `PROJECT_ID.VW_PHM_CONFDIM_CONTRACT.CONTRACT_BUYING_GROUP_RLT_CV` CNT_BYT_GRP_RLT ON VEDN_BLK_CNT_NUM.CNTRCT_NUM_ID = CNT_BYT_GRP_RLT.CNTRCT_NUM AND CNT_BYT_GRP_RLT.CURR_VRSN_FLG='Y' WHERE VEDN_BLK_CNT_NUM.CURR_VRSN_FLG ='Y' AND VEDN_BLK_CNT_NUM.VRSN_END_DTE >= CURRENT_DATE AND CNT_BYT_GRP_RLT.VRSN_END_DTE >= CURRENT_DATE ) select distinct RIGHT(SHIP_TO.DLVR_PLANT_ID,3) as division_number, SHIP_TO.CUSTOMER_NUM as ship_to_customer_number, VEND_BLK_DET.BUY_GROUP_NUM_ID as group_number, ltrim(VEND_BLK_DET.VENDOR_NUM_ID,'0') as vendor_number, CASE WHEN VEND_BLK_DET.VRSN_END_DTE >= CURRENT_DATE AND (VEND_BLK_DET.DEL_FLG = 'N' OR VEND_BLK_DET.DEL_FLG is null) then 'A' ELSE 'I' END  AS relationship_status, VEND_BLK_DET.VRSN_START_DTE as relationship_effective_date, FORMAT_DATETIME("%m/%d/%Y",current_datetime())||' 00:00:00' as record_effective_date, VEND_BLK_DET.CNTRCT_NUM_ID as Contract_Number from `PROJECT_ID.VW_PHM_CONFDIM_CUSTOMER.SHIPTO_CUSTOMER_SALES_AREA_RLT_CV` SHIP_TO JOIN VEND_BLK_DET ON SHIP_TO.SOLDTO_PARTY_CUSTOMER_NUM = VEND_BLK_DET.SOLDTO_CUSTOMER_NUM_ID and SHIP_TO.CURR_VRSN_FLG ='Y' AND VEND_BLK_DET.SALE_ORG_ID = SHIP_TO.SALE_ORG_ID AND VEND_BLK_DET.DIST_CHNL_ID = SHIP_TO.DIST_CHNL_ID AND VEND_BLK_DET.DIV_ID = SHIP_TO.DIV_ID JOIN `PROJECT_ID.VW_PHM_CONFDIM_CUSTOMER.CUSTOMER_CODE_CV` CUST_CODE ON CUST_CODE.CUSTOMER_NUM = SHIP_TO.CUSTOMER_NUM and CUST_CODE.SALE_ORG_ID = SHIP_TO.SALE_ORG_ID AND CUST_CODE.DIST_CHNL_ID = SHIP_TO.DIST_CHNL_ID AND CUST_CODE.DIV_ID = SHIP_TO.DIV_ID WHERE CUST_CODE.CDE_NUM_ID = '843' AND CUST_CODE.CDE_TYPE_ID ='P' and CUST_CODE.END_DTE >= CURRENT_DATE;

create or replace table `PROJECT_ID.D2_PHM_CONFFACT_PRICING.WAC_DATA_TEMP` as
Select distinct ifnull(right(concat(repeat('0',11),MAT_CV.CALC_NDC_ID),11), repeat('0',11)) as national_drug_code, case when PRI_VF.CALC_PREV_RFRNC_PRICE_AMT is null then 0.00 else PRI_VF.CALC_PREV_RFRNC_PRICE_AMT end as new_awp, case when PRI_VF.CALC_CORP_NIFO_AMT is null then 0.00 else PRI_VF.CALC_CORP_NIFO_AMT end new_corp_nifo, '0.00' as new_cost_plus, case when PRI_VF.DISC_WAC_AMT is null and PRI_VF.WAC_AMT is null then 0.00 else case when PRICE_USAGE_LKP_ID = 'ZDIS' then PRI_VF.DISC_WAC_AMT else PRI_VF.WAC_AMT END end as new_base_cost, case when PRI_VF.EXCISE_TAX_AMT is null then 0.00 else PRI_VF.EXCISE_TAX_AMT END as new_additional_charge, case when PRI_VF.VRSN_START_DTE is null then '01/01/1901' else format_date("%m/%d/%Y",PRI_VF.VRSN_START_DTE) end as effective_date, MAT_CV.XPLNT_MTRL_STAT_LKP_ID as activity_status_code, MAT_CV.XPLNT_MTRL_STAT_DESC_TXT as activity_description, case When MAT_CV.MTRL_GROUP_LKP_ID= 'ZGENERIC' THEN 1 When MAT_CV.MTRL_GROUP_LKP_ID = 'ZBRAND' THEN 2 ELSE 0 end as generic_indicator_code, TRIM(MAT_CV.CALC_CARD_SBST_KEY_ID) as cardinal_substitution_key, case when TRIM(MAT_CV.CARD_GCN_SEQ_NUM) ='' then '' else right(concat(repeat('0',6),MAT_CV.CARD_GCN_SEQ_NUM),6) end as cardinal_gcn_code, ltrim(MAT_CV.MTRL_NUM,'0') as corporate_item_number, TRIM(MAT_CV.HAM_FINEST_CLASS_LKP_ID) as hamacher_department_number, TRIM(MAT_CV.HAM_FINEST_CLASS_DESC_TXT) AS hamacher_description, TRIM(MAT_CV.FORM_LKP_ID) as form_id, TRIM(MAT_CV.FORM_DESC_TXT) as form_description, TRIM(MAT_CV.FDB_MULTI_SRC_IND_ID) as multi_source_indicator_code, MAT_CV.CALC_PACK_QTY as package_quantity, 0 as Accunet_Size, MAT_CV.BILL_UOM_ID as package_size_unit, TRIM(MAT_CV.BILL_UOM_DESC_TXT) as package_size_description, TRIM(MAT_CV.BASE_UOM_LKP_ID) as unit_code, TRIM(MAT_CV.BASE_UOM_DESC_TXT) as Unit_Code_Desc, 0 as Private_Label_Code, '' as Private_Label_Desc, MAT_CV.SIZE_DIM_TXT as Package_Size, TRIM(MAT_CV.STRGTH_TXT) as Strength, 0 as Total_Quantity, ifnull(TRIM(MAT_CV.TRADE_NAM),'') as Trade_Name, TRIM(MAT_CV.PACK_IND_LKP_ID) as Unit_Dose, ifnull(TRIM(MAT_CV.PACK_IND_DESC_TXT),'') as Unit_Dose_Desc, ifnull(TRIM(MED.DRUG_GROUP_CDE),'') as DRUG_GROUP_ID, ifnull(TRIM(MED.DRUG_GROUP_DESCRIPTION),'') as DESC_TXT, case when ltrim(TRIM(MAT_CV.SUPPLIER_NUM),'0') = '' then '0' else ltrim(MAT_CV.SUPPLIER_NUM,'0') end as Vendor_Number, ifnull(TRIM(MAT_CV.SUPPLIER_NAM),'') as Vendor_Name, ifnull(TRIM(MAT_CV.CALC_DEA_SCHED_ID),'00') as DEA_Schedule_Number, MAT_CV.DEA_SCHED_NUM_DESC_TXT as deaSchedDesc, 0 as Item_Type_Code, '' as Item_Type_Code_Description, 0 as Department_Code, '' as department_description, MAT_CV.STICKER_QTY as caseQty, ifnull(MAT_CV.CARD_AHFS_CDE ,'')as ahfs_description, ifnull(FD_MAS.RT,'') as route_administration, 1 as minPackQty, MAT_CV.GEN_NAM_TXT as generic_name, ifnull(FD_MAS.OBC,'') as orange_book_code, ifnull(FD_MAS.GCN_SEQNO,'') as hicl_seq_number, '' as hicl , MAT_CV.CALC_ACCUNET_QTY as totalCaseQty, FORMAT_DATETIME("%m/%d/%Y",current_datetime())||' 00:00:00' as recordDate, ifnull(MAT_CV.CALC_RX_FLG,'N') as rxIndicator, CASE WHEN PLT_RLT_CV.PLANT_ID  IS NULL THEN 'N' ELSE 'Y' END as prItem, ifnull(MAT_CV.MTRL_TYPE_LKP_ID,'') as materialType, ifnull(MAT_CV.MTRL_GROUP_LKP_ID,'') as materialGroup, ifnull(MAT_CV.MTRL_GROUP_PACK_MTRL_LKP_ID,'') as materialPackageGroup, ifnull(MAT_CV.ITEM_CTGRY_GROUP_LKP_ID,'') as materialGroupCategory, case when vizientItem.MTRL_NUM_ID is null then 'N' else 'Y' END as VIZIENT_ITM, case when PREMIERPRORX_ITM.MTRL_NUM_ID is null then 'N' else 'Y' END as PREMIERPRORX_ITM  From `PROJECT_ID.VW_PHM_CONFDIM_MATERIAL.MATERIAL_CV` MAT_CV left outer join  `PROJECT_ID.VW_PHM_CONFDIM_MATERIAL.MEDISPAN_MASTER_CV` MED on MAT_CV.CALC_NDC_ID = MED.NDC_UPC_HRI_ID left outer join `PROJECT_ID.VW_PHM_CONFDIM_MATERIAL.FDB_MASTER_CV` FD_MAS on MAT_CV.CALC_NDC_ID = FD_MAS.NDC left outer join  `PROJECT_ID.VW_PHM_CONFDIM_MATERIAL.MATERIAL_PRICING_VF` PRI_VF on MAT_CV.MTRL_NUM = PRI_VF.MTRL_NUM AND PRI_VF.CURR_VRSN_FLG = 'Y' left outer join  `PROJECT_ID.VW_PHM_CONFDIM_MATERIAL.MATERIAL_PLANT_RLT_CV` PLT_RLT_CV on MAT_CV.MTRL_NUM = PLT_RLT_CV.MTRL_NUM AND PLT_RLT_CV.PLANT_ID = 'P066' left outer join `PROJECT_ID.VW_PHM_CONFDIM_MATERIAL.VW_LOCAL_INCL_EXCL_CUSTLIST_MTRL` vizientItem on MAT_CV.MTRL_NUM = vizientItem.MTRL_NUM_ID AND vizientItem.CURR_VRSN_FLG = 'Y'  AND vizientItem.CNTRCT_NUM_ID = '0000300209' left outer join `PROJECT_ID.VW_PHM_CONFDIM_MATERIAL.VW_LOCAL_INCL_EXCL_CUSTLIST_MTRL` PREMIERPRORX_ITM on MAT_CV.MTRL_NUM = PREMIERPRORX_ITM.MTRL_NUM_ID AND PREMIERPRORX_ITM.CURR_VRSN_FLG = 'Y'  AND PREMIERPRORX_ITM.CNTRCT_NUM_ID = '0000300223' where MAT_CV.CURR_VRSN_FLG ='Y' AND MAT_CV.MTRL_TYPE_LKP_ID LIKE 'Z%' AND  MAT_CV.MTRL_TYPE_LKP_ID <> 'ZREB';

create or replace table `PROJECT_ID.D2_PHM_CONFFACT_PRICING.GRP_FUTURE_PRICE_TEMP` as
Select distinct BUY_GP_RLT.BUY_GROUP_ID as group_number, BUY_GP.BUY_GROUP_DESC_TXT as group_name, CNT_CV.CNTRCT_TYPE_LKP_ID as group_type, CNT_CV.CNTRCT_TYPE_DESC_TXT as cntrct_desc, GRP_REF.CTGREF  as group_reference, CNT_CV.CNTRCT_NUM as contract_number, extract(year from CNT_CV.CNTRCT_START_DTE) as contract_effective_year, extract(month from CNT_CV.CNTRCT_START_DTE) as contract_effective_month, extract(day from CNT_CV.CNTRCT_START_DTE) as contract_effective_date, extract(year from CNT_CV.CNTRCT_END_DTE) as contract_term_year, extract(month from CNT_CV.CNTRCT_END_DTE) as contract_term_month, extract(day from CNT_CV.CNTRCT_END_DTE) as contract_term_date, ltrim(SUP_CV.SUPPLIER_NUM,'0') as vendor_number, SUP_CV.SUPPLIER_NAM as vendor_name, ltrim(SUP_CV.PARENT_SUPPLIER_NUM,'0') as parent_vendor_number, SUP_CV.SUPPLIER_NAM as parent_vendor_name, CASE WHEN MAT_DE_V.MTRL_NUM IS NULL THEN 'A' WHEN MAT_DE_V.VRSN_END_DTE = PEND_MAT_DE_VF.VRSN_END_DTE THEN 'U' WHEN MAT_DE_V.VRSN_END_DTE > PEND_MAT_DE_VF.VRSN_END_DTE THEN 'D' ELSE 'C'  END as chg_cde, extract(year from PEND_MAT_DE_VF.CREATE_ON_DTE) as change_effective_year, extract(month from PEND_MAT_DE_VF.VRSN_START_DTE) as change_effective_month, extract(day from PEND_MAT_DE_VF.CREATE_ON_DTE) as change_effective_date, '' as chg_time, ltrim(PEND_MAT_DE_VF.MTRL_NUM,'0') as corporate_item_number, MAT_CV.MTRL_DESC_TXT as corporate_description, ifnull(right(concat(repeat('0',11),MAT_CV.CALC_NDC_ID),11), repeat('0',11)) as national_drug_code, PEND_MAT_DE_VF.CALC_CNTRCT_COST_AMT as contract_cost, PEND_MAT_DE_VF.CALC_SELL_PRICE_AMT as contract_sell, GRP_REF.parent_affiliation_id as parent_affiliation_id, GRP_REF.parent_affiliation as parent_affiliation, CASE WHEN MAT_DE_V.CGBK_RFRNC_NUM_ID ='' THEN CNT_CV.CGBK_RFRNC_NUM_ID ELSE MAT_DE_V.CGBK_RFRNC_NUM_ID END  as vendor_reference, extract(year from PEND_MAT_DE_VF.VRSN_START_DTE) as item_effective_year, extract(month from PEND_MAT_DE_VF.VRSN_START_DTE) as item_effective_month, extract(day from PEND_MAT_DE_VF.VRSN_START_DTE) as item_effective_date, FORMAT_DATETIME("%m/%d/%Y",current_datetime())||' 00:00:00' as record_effective_date from `PROJECT_ID.VW_PHM_CONFDIM_CONTRACT.CONTRACT_MTRL_DETAIL_PENDING_VF` PEND_MAT_DE_VF left outer join `PROJECT_ID.VW_PHM_CONFDIM_CONTRACT.CONTRACT_MATERIAL_DETAIL_VF` MAT_DE_V on MAT_DE_V.CNTRCT_NUM = PEND_MAT_DE_VF.CNTRCT_NUM and MAT_DE_V.MTRL_NUM = PEND_MAT_DE_VF.MTRL_NUM and MAT_DE_V.CURR_VRSN_FLG = 'Y' join `PROJECT_ID.VW_PHM_CONFDIM_CONTRACT.CONTRACT_CV` CNT_CV on PEND_MAT_DE_VF.CNTRCT_NUM=CNT_CV.CNTRCT_NUM AND CNT_CV.CURR_VRSN_FLG ='Y' join `PROJECT_ID.VW_PHM_CONFDIM_MATERIAL.MATERIAL_CV` MAT_CV on MAT_CV.MTRL_NUM=PEND_MAT_DE_VF.MTRL_NUM  AND MAT_CV.CURR_VRSN_FLG ='Y'   join `PROJECT_ID.VW_PHM_CONFDIM_CONTRACT.CONTRACT_BUYING_GROUP_RLT_CV` BUY_GP_RLT on BUY_GP_RLT.CNTRCT_NUM=CNT_CV.CNTRCT_NUM  AND BUY_GP_RLT.CURR_VRSN_FLG ='Y' join `PROJECT_ID.VW_PHM_CONFDIM_CONTRACT.BUYING_GROUP_CV` BUY_GP on BUY_GP.BUY_GROUP_ID=BUY_GP_RLT.BUY_GROUP_ID AND BUY_GP.CURR_VRSN_FLG ='Y' join `PROJECT_ID.VW_PHM_CONFDIM_SUPPLIER.SUPPLIER_CV` SUP_CV on SUP_CV.SUPPLIER_NUM=MAT_CV.SUPPLIER_NUM AND SUP_CV.CURR_VRSN_FLG ='Y' LEFT OUTER JOIN ( select DISTINCT PEND_MAT_DE_VF.CNTRCT_NUM, CASE WHEN C.GPO_GROUP_ID <> '' THEN G.CCA_GROUP_RFRNC_ID ELSE H.CCA_GROUP_RFRNC_ID END CTGREF, D.BUY_GROUP_ID, E.RFRNC_BUY_GROUP_ORG_NUM AS parent_affiliation_id, E.BUY_GROUP_ORG_NAM AS parent_affiliation FROM `PROJECT_ID.VW_PHM_CONFDIM_CONTRACT.CONTRACT_MTRL_DETAIL_PENDING_VF` PEND_MAT_DE_VF join `PROJECT_ID.VW_PHM_CONFDIM_CONTRACT.CONTRACT_CV` C on c.CNTRCT_NUM = PEND_MAT_DE_VF.CNTRCT_NUM LEFT OUTER join `PROJECT_ID.VW_PHM_CONFDIM_CONTRACT.CONTRACT_BUYING_GROUP_RLT_CV` B on B.CNTRCT_NUM=C.CNTRCT_NUM and C.CURR_VRSN_FLG='Y' left outer join `PROJECT_ID.VW_PHM_CONFDIM_CONTRACT.BUYING_GROUP_CV` D ON D.BUY_GROUP_ID = B.BUY_GROUP_ID AND D.CURR_VRSN_FLG ='Y' left outer join `PROJECT_ID.VW_PHM_CONFDIM_CONTRACT.BUYING_GROUP_ORGANIZATION_CV` E ON E.BUY_GROUP_ORG_NUM =b.BUY_GROUP_ORG_NUM AND E.CURR_VRSN_FLG ='Y' left outer join `PROJECT_ID.VW_PHM_CONFDIM_CONTRACT.BUYING_GROUP_ORGANIZATION_CV` H ON H.BUY_GROUP_ORG_NUM =E.RFRNC_BUY_GROUP_ORG_NUM AND H.CURR_VRSN_FLG ='Y' left outer join `PROJECT_ID.VW_PHM_CONFDIM_CONTRACT.BUYING_GROUP_ORGANIZATION_CV` G ON G.BUY_GROUP_ORG_NUM =C.GPO_GROUP_ID AND G.CURR_VRSN_FLG ='Y' ) GRP_REF ON GRP_REF.CNTRCT_NUM = CNT_CV.CNTRCT_NUM AND GRP_REF.BUY_GROUP_ID = BUY_GP_RLT.BUY_GROUP_ID JOIN ( select distinct RLT_CV.BUY_GROUP_ID from `PROJECT_ID.VW_PHM_CONFDIM_CONTRACT.BUYING_GROUP_CUSTOMER_RLT_CV` RLT_CV JOIN `PROJECT_ID.VW_PHM_CONFDIM_CUSTOMER.CUSTOMER_CODE_CV` CUST_CODE ON CUST_CODE.CUSTOMER_NUM = RLT_CV.CUSTOMER_NUM AND CUST_CODE.SALE_ORG_ID = RLT_CV.SALE_ORG_ID AND CUST_CODE.DIST_CHNL_ID = RLT_CV.DIST_CHNL_ID AND CUST_CODE.DIV_ID = RLT_CV.DIV_ID JOIN `PROJECT_ID.VW_PHM_CONFDIM_CUSTOMER.SHIPTO_CUSTOMER_SALES_AREA_RLT_CV` SHIP_TO ON SHIP_TO.SOLDTO_PARTY_CUSTOMER_NUM = RLT_CV.CUSTOMER_NUM AND SHIP_TO.CURR_VRSN_FLG ='Y' AND CUST_CODE.SALE_ORG_ID = SHIP_TO.SALE_ORG_ID AND CUST_CODE.DIST_CHNL_ID = SHIP_TO.DIST_CHNL_ID AND CUST_CODE.DIV_ID = SHIP_TO.DIV_ID join `PROJECT_ID.VW_PHM_CONFDIM_CONTRACT.CONTRACT_BUYING_GROUP_RLT_CV` BUY_GROUP_RLT ON BUY_GROUP_RLT.BUY_GROUP_ID = RLT_CV.BUY_GROUP_ID AND BUY_GROUP_RLT.CURR_VRSN_FLG ='Y' Join `PROJECT_ID.VW_PHM_CONFDIM_CONTRACT.CONTRACT_CV` CNT_CV ON CNT_CV.CNTRCT_NUM = BUY_GROUP_RLT.CNTRCT_NUM AND CNT_CV.CURR_VRSN_FLG ='Y' WHERE CUST_CODE.CDE_NUM_ID = '843' AND CUST_CODE.CDE_TYPE_ID ='P' AND CNT_CV.CNTRCT_TYPE_LKP_ID NOT IN ('P','T') and RLT_CV.CURR_VRSN_FLG='Y'  AND CUST_CODE.END_DTE >= CURRENT_DATE) BUY_GRP_LIST ON BUY_GRP_LIST.BUY_GROUP_ID = BUY_GP.BUY_GROUP_ID WHERE PEND_MAT_DE_VF.CURR_VRSN_FLG ='Y' AND CNT_CV.CNTRCT_TYPE_LKP_ID NOT IN ('P','T') and PEND_MAT_DE_VF.VRSN_START_DTE >= CURRENT_DATE and PEND_MAT_DE_VF.UPDATE_IND_ID <> 'D';

create or replace table `PROJECT_ID.D2_PHM_CONFFACT_PRICING.CHPC_MBR_ACCESS_TEMP` as
SELECT DISTINCT SHIP_TO.AFLTN_LEVEL1_CUSTOMER_NUM as root_affiliation_number, SHIP_TO.AFLTN_LEVEL1_CUSTOMER_NAM as root_affiliation_name, SHIP_TO.AFLTN_LEVEL3_CUSTOMER_NUM as affiliation_number, SHIP_TO.AFLTN_LEVEL3_CUSTOMER_NAM as affiliation_name, RIGHT(SHIP_TO.DLVR_PLANT_ID,3) as group_id, CUST_RLT_CV.CUSTOMER_NUM as ship_to_customer_number, CUST.CUSTOMER_NAM as ship_to_customer_name, CUST_RLT_CV.BUY_GROUP_ID as group_number, BUY_CV.BUY_GROUP_DESC_TXT as group_name, CUST_RLT_CV.CNTRCT_RANK_PRTY_NUM as group_priority_ranking, CUST_RLT_CV.CNTRCT_RANK_PREFER_NUM as secondary_priority_ranking, case when CUST.DEL_IND_FLG ='X' THEN 'I' ELSE 'A' END account_status_flag, CASE WHEN CODE_CV.END_DTE < CURRENT_DATE THEN 'I' WHEN CODE_CV.START_DTE <= CURRENT_DATE AND CODE_CV.END_DTE >= CURRENT_DATE THEN 'A' WHEN CODE_CV.START_DTE > CURRENT_DATE THEN 'F' END relationship_status_flag, format_date("%m/%d/%Y",CUST_RLT_CV.VRSN_START_DTE) as relationship_effective_date, 0 as edi_type_code, FORMAT_DATETIME("%m/%d/%Y",current_datetime())||' 00:00:00'  as record_effective_date, SHIP_TO.AFLTN_LEVEL2_CUSTOMER_NUM AS A2_root_affiliation_number, SHIP_TO.AFLTN_LEVEL2_CUSTOMER_NAM AS A2_root_affiliation_name from `PROJECT_ID.VW_PHM_CONFDIM_CONTRACT.BUYING_GROUP_CUSTOMER_RLT_CV` CUST_RLT_CV join `PROJECT_ID.VW_PHM_CONFDIM_CUSTOMER.SHIPTO_CUSTOMER_SALES_AREA_RLT_CV` SHIP_TO ON SHIP_TO.SOLDTO_PARTY_CUSTOMER_NUM = CUST_RLT_CV.CUSTOMER_NUM AND SHIP_TO.CURR_VRSN_FLG ='Y' join  `PROJECT_ID.VW_PHM_CONFDIM_CUSTOMER.CUSTOMER_CODE_CV` CODE_CV on CODE_CV.CUSTOMER_NUM=SHIP_TO.CUSTOMER_NUM AND CODE_CV.SALE_ORG_ID = SHIP_TO.SALE_ORG_ID AND CODE_CV.DIST_CHNL_ID = SHIP_TO.DIST_CHNL_ID AND CODE_CV.DIV_ID = SHIP_TO.DIV_ID join `PROJECT_ID.VW_PHM_CONFDIM_CUSTOMER.CUSTOMER_CV` CUST on CUST.CUSTOMER_NUM=CUST_RLT_CV.CUSTOMER_NUM and CUST.CURR_VRSN_FLG='Y' AND CODE_CV.SALE_ORG_ID = CUST_RLT_CV.SALE_ORG_ID AND CODE_CV.DIST_CHNL_ID = CUST_RLT_CV.DIST_CHNL_ID AND CODE_CV.DIV_ID = CUST_RLT_CV.DIV_ID join `PROJECT_ID.VW_PHM_CONFDIM_CONTRACT.BUYING_GROUP_CV` BUY_CV on BUY_CV.BUY_GROUP_ID=CUST_RLT_CV.BUY_GROUP_ID and BUY_CV.CURR_VRSN_FLG='Y' AND BUY_CV.CURR_VRSN_FLG ='Y' WHERE CUST_RLT_CV.CURR_VRSN_FLG ='Y' AND CODE_CV.CDE_NUM_ID = '843' AND CODE_CV.CDE_TYPE_ID ='P' AND CUST_RLT_CV.VRSN_END_DTE >= CURRENT_DATE AND BUY_CV.VRSN_END_DTE >= CURRENT_DATE AND CODE_CV.END_DTE >= CURRENT_DATE AND CUST.DEL_IND_FLG = '';

create or replace table `PROJECT_ID.D2_PHM_CONFFACT_PRICING.GRP_CURPRC_TEMP` as
Select distinct BUY_GP_RLT.BUY_GROUP_ID as group_number, BUY_GP.BUY_GROUP_DESC_TXT as group_name, CNT_CV.CNTRCT_TYPE_LKP_ID as group_type_id, CNT_CV.CNTRCT_TYPE_DESC_TXT as contract_description, GRP_REF.CTGREF  as group_reference, CNT_CV.CNTRCT_NUM as contract_number, extract(year from CNT_CV.CNTRCT_START_DTE) as contract_effective_year, extract(month from CNT_CV.CNTRCT_START_DTE) as contract_effective_month, extract(day from CNT_CV.CNTRCT_START_DTE) as contract_effective_date, extract(year from CNT_CV.CNTRCT_END_DTE) as contract_term_year, extract(month from CNT_CV.CNTRCT_END_DTE) as contract_term_month, extract(day from CNT_CV.CNTRCT_END_DTE) as contract_term_date, ltrim(SUP_CV.SUPPLIER_NUM,'0') as vendor_number, SUP_CV.SUPPLIER_NAM as vendor_name, ltrim(SUP_CV.PARENT_SUPPLIER_NUM,'0') as parent_vendor_number, SUP_CV.PARENT_SUPPLIER_NAM as parent_vendor_name, LTRIM(MAT_DE_VF.MTRL_NUM,'0') as corporate_item_number, MAT_CV.MTRL_DESC_TXT as corporate_description, ifnull(right(concat(repeat('0',11),MAT_CV.CALC_NDC_ID),11), repeat('0',11)) as national_drug_code, MAT_DE_VF.CALC_CNTRCT_COST_PLUS_EXCISE_TAX_AMT as contract_cost, MAT_DE_VF.CALC_SELL_PRICE_AMT as contract_sell, GRP_REF.parent_affiliation_id as parent_affiliation_id, GRP_REF.parent_affiliation as parent_affiliation, CASE WHEN MAT_DE_VF.CGBK_RFRNC_NUM_ID ='' THEN CNT_CV.CGBK_RFRNC_NUM_ID ELSE MAT_DE_VF.CGBK_RFRNC_NUM_ID END  as vendor_reference, format_date("%m/%d/%Y",MAT_DE_VF.VRSN_START_DTE ) as item_effective_date, FORMAT_DATETIME("%m/%d/%Y",current_datetime())||' 00:00:00' as record_effective_date from `PROJECT_ID.VW_PHM_CONFDIM_CONTRACT.CONTRACT_MATERIAL_DETAIL_VF` MAT_DE_VF join `PROJECT_ID.VW_PHM_CONFDIM_CONTRACT.CONTRACT_CV` CNT_CV on MAT_DE_VF.CNTRCT_NUM=CNT_CV.CNTRCT_NUM AND CNT_CV.CURR_VRSN_FLG ='Y' join `PROJECT_ID.VW_PHM_CONFDIM_MATERIAL.MATERIAL_CV` MAT_CV on MAT_CV.MTRL_NUM=MAT_DE_VF.MTRL_NUM  AND MAT_CV.CURR_VRSN_FLG ='Y'   join `PROJECT_ID.VW_PHM_CONFDIM_CONTRACT.CONTRACT_BUYING_GROUP_RLT_CV` BUY_GP_RLT on BUY_GP_RLT.CNTRCT_NUM=CNT_CV.CNTRCT_NUM  AND BUY_GP_RLT.CURR_VRSN_FLG ='Y' join `PROJECT_ID.VW_PHM_CONFDIM_CONTRACT.BUYING_GROUP_CV` BUY_GP on BUY_GP.BUY_GROUP_ID=BUY_GP_RLT.BUY_GROUP_ID AND BUY_GP.CURR_VRSN_FLG ='Y' join `PROJECT_ID.VW_PHM_CONFDIM_SUPPLIER.SUPPLIER_CV` SUP_CV on SUP_CV.SUPPLIER_NUM=MAT_CV.SUPPLIER_NUM AND SUP_CV.CURR_VRSN_FLG ='Y' LEFT OUTER JOIN ( select DISTINCT C.CNTRCT_NUM, CASE WHEN C.GPO_GROUP_ID <> '' THEN G.CCA_GROUP_RFRNC_ID ELSE H.CCA_GROUP_RFRNC_ID END CTGREF, D.BUY_GROUP_ID, E.RFRNC_BUY_GROUP_ORG_NUM AS parent_affiliation_id, E.BUY_GROUP_ORG_NAM AS parent_affiliation FROM `PROJECT_ID.VW_PHM_CONFDIM_CONTRACT.CONTRACT_CV` C LEFT OUTER join `PROJECT_ID.VW_PHM_CONFDIM_CONTRACT.CONTRACT_BUYING_GROUP_RLT_CV` B on B.CNTRCT_NUM=C.CNTRCT_NUM and C.CURR_VRSN_FLG='Y' left outer join `PROJECT_ID.VW_PHM_CONFDIM_CONTRACT.BUYING_GROUP_CV` D ON D.BUY_GROUP_ID = B.BUY_GROUP_ID AND D.CURR_VRSN_FLG ='Y' left outer join `PROJECT_ID.VW_PHM_CONFDIM_CONTRACT.BUYING_GROUP_ORGANIZATION_CV` E ON E.BUY_GROUP_ORG_NUM =b.BUY_GROUP_ORG_NUM AND E.CURR_VRSN_FLG ='Y' left outer join `PROJECT_ID.VW_PHM_CONFDIM_CONTRACT.BUYING_GROUP_ORGANIZATION_CV` H ON H.BUY_GROUP_ORG_NUM =E.RFRNC_BUY_GROUP_ORG_NUM AND H.CURR_VRSN_FLG ='Y' left outer join `PROJECT_ID.VW_PHM_CONFDIM_CONTRACT.BUYING_GROUP_ORGANIZATION_CV` G ON G.BUY_GROUP_ORG_NUM =C.GPO_GROUP_ID AND G.CURR_VRSN_FLG ='Y' ) GRP_REF ON GRP_REF.CNTRCT_NUM = CNT_CV.CNTRCT_NUM AND GRP_REF.BUY_GROUP_ID = BUY_GP_RLT.BUY_GROUP_ID JOIN ( select distinct RLT_CV.BUY_GROUP_ID from `PROJECT_ID.VW_PHM_CONFDIM_CONTRACT.BUYING_GROUP_CUSTOMER_RLT_CV` RLT_CV JOIN `PROJECT_ID.VW_PHM_CONFDIM_CUSTOMER.CUSTOMER_CODE_CV` CUST_CODE ON CUST_CODE.CUSTOMER_NUM = RLT_CV.CUSTOMER_NUM AND CUST_CODE.SALE_ORG_ID = RLT_CV.SALE_ORG_ID AND CUST_CODE.DIST_CHNL_ID = RLT_CV.DIST_CHNL_ID AND CUST_CODE.DIV_ID = RLT_CV.DIV_ID JOIN `PROJECT_ID.VW_PHM_CONFDIM_CUSTOMER.SHIPTO_CUSTOMER_SALES_AREA_RLT_CV` SHIP_TO ON SHIP_TO.SOLDTO_PARTY_CUSTOMER_NUM = RLT_CV.CUSTOMER_NUM AND SHIP_TO.CURR_VRSN_FLG ='Y' AND CUST_CODE.SALE_ORG_ID = SHIP_TO.SALE_ORG_ID AND CUST_CODE.DIST_CHNL_ID = SHIP_TO.DIST_CHNL_ID AND CUST_CODE.DIV_ID = SHIP_TO.DIV_ID join `PROJECT_ID.VW_PHM_CONFDIM_CONTRACT.CONTRACT_BUYING_GROUP_RLT_CV` BUY_GROUP_RLT ON BUY_GROUP_RLT.BUY_GROUP_ID = RLT_CV.BUY_GROUP_ID AND BUY_GROUP_RLT.CURR_VRSN_FLG ='Y' Join `PROJECT_ID.VW_PHM_CONFDIM_CONTRACT.CONTRACT_CV` CNT_CV ON CNT_CV.CNTRCT_NUM = BUY_GROUP_RLT.CNTRCT_NUM AND CNT_CV.CURR_VRSN_FLG ='Y' WHERE CUST_CODE.CDE_NUM_ID = '843' AND CUST_CODE.CDE_TYPE_ID ='P' AND CNT_CV.CNTRCT_TYPE_LKP_ID NOT IN ('P','T') and RLT_CV.CURR_VRSN_FLG='Y'  AND CUST_CODE.END_DTE >= CURRENT_DATE) BUY_GRP_LIST ON BUY_GRP_LIST.BUY_GROUP_ID = BUY_GP.BUY_GROUP_ID WHERE MAT_DE_VF.CURR_VRSN_FLG ='Y' AND CNT_CV.CNTRCT_TYPE_LKP_ID NOT IN ('P','T') and CNT_CV.CNTRCT_END_DTE >= CURRENT_DATE;
*/
CREATE OR REPLACE TABLE `PROJECT_ID.D2_PHM_CONFFACT_PRICING.CHPC_BCKORD_TEMP` AS
SELECT DISTINCT CALC_CARD_SBST_KEY_ID AS cardinal_substitution_key, SUPPLIER_NAM vendor_name, LTRIM(AVAIL_ALERT.MTRL_NUM,'0') AS corporate_item_number, ifnull(right(concat(repeat('0',11),MAT_CV.CALC_NDC_ID),11), repeat('0',11)) AS national_drug_code, MTRL_DESC_TXT AS corporate_description, LTRIM(AVAIL_ALERT.MTRL_NUM,'0') AS AAAITEM, AVAIL_ALERT_CDE AS availability_alert_code, EXPDT_CDE AS external_message_code, AVAIL_ALERT_EXTRNL_MSG_TXT AS external_message, EXPCT_DLVRY_DTE AS expected_delivery_date, AVAIL_ALERT_INTRNL_MSG_TXT AS internal_message, CLNDR_DTE AS change_date, STAT_DTE AS origination_date, '' AS expediting_code_type FROM `PROJECT_ID.VW_PHM_CONFDIM_MATERIAL.MATERIAL_CV` MAT_CV JOIN `PROJECT_ID.VW_PHM_CONFFACT_INVENTORY.AVAILABILITY_ALERT_TRNSCT` AVAIL_ALERT ON MAT_CV.MTRL_NUM = AVAIL_ALERT.MTRL_NUM WHERE MAT_CV.CURR_VRSN_FLG = 'Y';

END;