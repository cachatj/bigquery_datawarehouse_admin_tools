CREATE PROCEDURE `PROJECT_ID`.D2_PHM_CONFFACT_PRICING.SP_WAC_DATA_DOUbLE_QUOTE()
BEGIN
/*******************************************************************************************************************************************

Name: Shaik, Shareef
Date: Fe 22, 2024ca
Project: GPSC Iteration 2
Description: Create temp table;
Marker :
--------------------------------------------------------------------------------------------------
********************************************************************************************************************************************************/

CREATE OR REPLACE TABLE `PROJECT_ID.D2_PHM_CONFFACT_PRICING.WAC_DATA_DOUbLE_QUOTE` AS
SELECT * FROM (   SELECT DISTINCT ifnull(right(concat(repeat('0',11),MAT_CV.CALC_NDC_ID),11), repeat('0',11)) AS national_drug_code, CASE WHEN PRI_VF.RFRNC_PRICE_AMT IS NULL THEN 0.00 ELSE PRI_VF.RFRNC_PRICE_AMT END AS new_awp, CASE WHEN PRI_VF.CALC_CORP_NIFO_AMT IS NULL THEN 0.00 ELSE PRI_VF.CALC_CORP_NIFO_AMT END new_corp_nifo, '0.00' AS new_cost_plus, CASE WHEN PRI_VF.DISC_WAC_AMT IS NULL AND PRI_VF.WAC_AMT IS NULL THEN 0.00 ELSE  CASE WHEN PRICE_USAGE_LKP_ID = 'ZDIS' THEN PRI_VF.DISC_WAC_AMT ELSE PRI_VF.WAC_AMT END END AS new_base_cost, CASE WHEN PRI_VF.EXCISE_TAX_AMT IS NULL THEN 0.00 ELSE PRI_VF.EXCISE_TAX_AMT END AS new_additional_charge, CASE WHEN PRI_VF.VRSN_START_DTE IS NULL THEN '01/01/1901' ELSE format_date("%m/%d/%Y",PRI_VF.VRSN_START_DTE) END AS effective_date, MAT_CV.XPLNT_MTRL_STAT_LKP_ID AS activity_status_code, MAT_CV.XPLNT_MTRL_STAT_DESC_TXT AS activity_description, CASE WHEN MAT_CV.MTRL_GROUP_LKP_ID= 'ZGENERIC' THEN 1 WHEN MAT_CV.MTRL_GROUP_LKP_ID = 'ZBRAND' THEN 2 ELSE 0 END AS generic_indicator_code, TRIM(MAT_CV.CALC_CARD_SBST_KEY_ID) AS cardinal_substitution_key, CASE WHEN TRIM(MAT_CV.CARD_GCN_SEQ_NUM) ='' THEN '' ELSE right(concat(repeat('0',6),MAT_CV.CARD_GCN_SEQ_NUM),6) END AS cardinal_gcn_code, ltrim(MAT_CV.MTRL_NUM,'0') AS corporate_item_number, TRIM(MAT_CV.HAM_FINEST_CLASS_LKP_ID) AS hamacher_department_number, TRIM(MAT_CV.HAM_FINEST_CLASS_DESC_TXT) AS hamacher_description, TRIM(MAT_CV.FORM_LKP_ID) AS form_id, TRIM(MAT_CV.FORM_DESC_TXT) AS form_description, TRIM(MAT_CV.FDB_MULTI_SRC_IND_ID) AS multi_source_indicator_code, MAT_CV.CALC_PACK_QTY AS package_quantity, 0 AS Accunet_Size, MAT_CV.BILL_UOM_ID AS package_size_unit, TRIM(MAT_CV.BILL_UOM_DESC_TXT) AS package_size_description, TRIM(MAT_CV.BASE_UOM_LKP_ID) AS unit_code, TRIM(MAT_CV.BASE_UOM_DESC_TXT) AS Unit_Code_Desc, 0 AS Private_Label_Code, '' AS Private_Label_Desc, MAT_CV.SIZE_DIM_TXT AS Package_Size, TRIM(MAT_CV.STRGTH_TXT) AS Strength, 0 AS Total_Quantity, ifnull(TRIM(MAT_CV.TRADE_NAM),'') AS Trade_Name, TRIM(MAT_CV.PACK_IND_LKP_ID) AS Unit_Dose, ifnull(TRIM(MAT_CV.PACK_IND_DESC_TXT),'') AS Unit_Dose_Desc, ifnull(TRIM(MED.DRUG_GROUP_CDE),'') AS DRUG_GROUP_ID, ifnull(TRIM(MED.DRUG_GROUP_DESCRIPTION),'') AS DESC_TXT, CASE WHEN ltrim(TRIM(MAT_CV.SUPPLIER_NUM),'0') = '' THEN '0' ELSE ltrim(MAT_CV.SUPPLIER_NUM,'0') END AS Vendor_Number, ifnull(TRIM(MAT_CV.SUPPLIER_NAM),'') AS Vendor_Name, ifnull(TRIM(MAT_CV.CALC_DEA_SCHED_ID),'00') AS DEA_Schedule_Number, MAT_CV.DEA_SCHED_NUM_DESC_TXT AS deaSchedDesc, 0 AS Item_Type_Code, '' AS Item_Type_Code_Description, 0 AS Department_Code, '' AS department_description, MAT_CV.STICKER_QTY AS caseQty, ifnull(MAT_CV.CARD_AHFS_CDE ,'')AS ahfs_description, ifnull(FD_MAS.RT,'') AS route_administration, 1 AS minPackQty, MAT_CV.GEN_NAM_TXT AS generic_name, ifnull(FD_MAS.OBC,'') AS orange_book_code, ifnull(FD_MAS.GCN_SEQNO,'') AS hicl_seq_number, '' AS hicl , MAT_CV.CALC_ACCUNET_QTY AS totalCaseQty, FORMAT_DATETIME("%m/%d/%Y",current_date('EST'))||' 00:00:00' AS recordDate, ifnull(MAT_CV.CALC_RX_FLG,'N') AS rxIndicator, CASE WHEN PLT_RLT_CV.PLANT_ID  IS NULL THEN 'N' ELSE 'Y' END AS prItem, ifnull(MAT_CV.MTRL_TYPE_LKP_ID,'') AS materialType, ifnull(MAT_CV.MTRL_GROUP_LKP_ID,'') AS materialGroup, ifnull(MAT_CV.MTRL_GROUP_PACK_MTRL_LKP_ID,'') AS materialPackageGroup, ifnull(MAT_CV.ITEM_CTGRY_GROUP_LKP_ID,'') AS materialGroupCategory, CASE WHEN vizientItem.MTRL_NUM_ID IS NULL THEN 'N' ELSE 'Y' END AS VIZIENT_ITM, CASE WHEN PREMIERPRORX_ITM.MTRL_NUM_ID IS NULL THEN 'N' ELSE 'Y' END AS PREMIERPRORX_ITM FROM `PROJECT_ID.VW_PHM_CONFDIM_MATERIAL.MATERIAL_CV` MAT_CV LEFT OUTER JOIN `PROJECT_ID.VW_PHM_CONFDIM_MATERIAL.MEDISPAN_MASTER_CV` MED ON ltrim(MAT_CV.CALC_NDC_ID,'0') = ltrim(MED.NDC_UPC_HRI_ID,'0') LEFT OUTER JOIN `PROJECT_ID.VW_PHM_CONFDIM_MATERIAL.FDB_MASTER_CV` FD_MAS ON ltrim(MAT_CV.CALC_NDC_ID,'0') = ltrim(FD_MAS.NDC,'0') LEFT OUTER JOIN `PROJECT_ID.VW_PHM_CONFDIM_MATERIAL.MATERIAL_PRICING_VF` PRI_VF ON MAT_CV.MTRL_NUM = PRI_VF.MTRL_NUM AND PRI_VF.CURR_VRSN_FLG = 'Y' LEFT OUTER JOIN `PROJECT_ID.VW_PHM_CONFDIM_MATERIAL.MATERIAL_PLANT_RLT_CV` PLT_RLT_CV ON MAT_CV.MTRL_NUM = PLT_RLT_CV.MTRL_NUM AND PLT_RLT_CV.PLANT_ID = 'P066'  LEFT OUTER JOIN `PROJECT_ID.VW_PHM_CONFDIM_MATERIAL.VW_LOCAL_INCL_EXCL_CUSTLIST_MTRL` vizientItem ON MAT_CV.MTRL_NUM = vizientItem.MTRL_NUM_ID AND vizientItem.CURR_VRSN_FLG = 'Y'  AND vizientItem.CNTRCT_NUM_ID = '0000300209' LEFT OUTER JOIN `PROJECT_ID.VW_PHM_CONFDIM_MATERIAL.VW_LOCAL_INCL_EXCL_CUSTLIST_MTRL` PREMIERPRORX_ITM ON MAT_CV.MTRL_NUM = PREMIERPRORX_ITM.MTRL_NUM_ID AND PREMIERPRORX_ITM.CURR_VRSN_FLG = 'Y'  AND PREMIERPRORX_ITM.CNTRCT_NUM_ID = '0000300223' WHERE  MAT_CV.CURR_VRSN_FLG ='Y' AND MAT_CV.MTRL_TYPE_LKP_ID LIKE 'Z%' AND  MAT_CV.MTRL_TYPE_LKP_ID <> 'ZREB'  )a WHERE a.national_drug_code IN ( '56114620000', '08489831210', '08489831110', '56123380000', '56115040000', '56126270000', '08489831410', '56111400000', '60002035771', '56140030000', '56140110000')
;

END;