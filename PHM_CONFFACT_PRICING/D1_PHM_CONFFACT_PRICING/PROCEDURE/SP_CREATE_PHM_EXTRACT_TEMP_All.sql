CREATE PROCEDURE `PROJECT_ID`.D1_PHM_CONFFACT_PRICING.SP_CREATE_PHM_EXTRACT_TEMP_All()
BEGIN
/*******************************************************************************************************************************************

Name: Shaik, Shareef
Date: Fe 22, 2024ca
Project: GPSC Iteration 2
Description: Create temp table;
Marker :
--------------------------------------------------------------------------------------------------
********************************************************************************************************************************************************/

CREATE OR REPLACE TABLE `PROJECT_ID.D2_PHM_CONFFACT_PRICING.SEGMENT_MASTER_TEMP` AS
SELECT DISTINCT  RLT_CV.BUY_GROUP_ID AS subgroup_number, BUY_CV.BUY_GROUP_DESC_TXT AS subgroup_description, 0 AS group_number , format_date("%m/%d/%Y",BUY_CV.VRSN_START_DTE) AS subgroup_effective_date, format_date("%m/%d/%Y",BUY_CV.VRSN_END_DTE) AS subgroup_term_date, FORMAT_DATETIME("%m/%d/%Y",current_datetime())||' 00:00:00' AS record_effective_date FROM `PROJECT_ID.VW_PHM_CONFDIM_CONTRACT.CONTRACT_BUYING_GROUP_RLT_CV` RLT_CV JOIN `PROJECT_ID.VW_PHM_CONFDIM_CONTRACT.BUYING_GROUP_CV` BUY_CV ON RLT_CV.BUY_GROUP_ID=BUY_CV.BUY_GROUP_ID  JOIN `PROJECT_ID.VW_PHM_CONFDIM_CONTRACT.CONTRACT_MATERIAL_DETAIL_VF` DETAIL_VF ON DETAIL_VF.CNTRCT_NUM=RLT_CV.CNTRCT_NUM  WHERE  RLT_CV.CURR_VRSN_FLG='Y' AND BUY_CV.CURR_VRSN_FLG ='Y' AND DETAIL_VF.CURR_VRSN_FLG ='Y' AND  DETAIL_VF.VRSN_END_DTE >= CURRENT_DATE AND  RLT_CV.VRSN_END_DTE >= CURRENT_DATE AND  DETAIL_VF.CNTRCT_TYPE_LKP_ID = 'P' ORDER BY 1 ;

CREATE OR REPLACE TABLE `PROJECT_ID.D2_PHM_CONFFACT_PRICING.SEGMENT_DETAIL_TEMP` AS
SELECT DISTINCT ltrim(DETAIL_VF.MTRL_NUM,'0') AS corporate_item_number, GROUP_RLT_CV.BUY_GROUP_ID AS subgroup_number, format_date("%m/%d/%Y",DETAIL_VF.VRSN_START_DTE) AS effective_date, format_date("%m/%d/%Y",DETAIL_VF.VRSN_END_DTE) AS term_date, FORMAT_DATETIME("%m/%d/%Y",current_datetime())||' 00:00:00' AS record_effective_date FROM `PROJECT_ID.VW_PHM_CONFDIM_CONTRACT.CONTRACT_MATERIAL_DETAIL_VF`  DETAIL_VF JOIN `PROJECT_ID.VW_PHM_CONFDIM_CONTRACT.CONTRACT_BUYING_GROUP_RLT_CV`  GROUP_RLT_CV ON DETAIL_VF.CNTRCT_NUM=GROUP_RLT_CV.CNTRCT_NUM  WHERE  DETAIL_VF.CURR_VRSN_FLG='Y' AND  GROUP_RLT_CV.CURR_VRSN_FLG ='Y' AND  DETAIL_VF.VRSN_END_DTE >= CURRENT_DATE AND  GROUP_RLT_CV.VRSN_END_DTE >= CURRENT_DATE AND  DETAIL_VF.CNTRCT_TYPE_LKP_ID = 'P' ORDER BY 1 ;

CREATE OR REPLACE TABLE `PROJECT_ID.D2_PHM_CONFFACT_PRICING.SEGMENT_ATTACHMENT_TEMP` AS
 SELECT DISTINCT RIGHT(SHIP_TO.DLVR_PLANT_ID,3) AS division_number, SHIP_TO.CUSTOMER_NUM AS ship_to_customer_number, RLT_CV.BUY_GROUP_ID AS subgroup_number, format_date("%m/%d/%Y",RLT_CV.VRSN_START_DTE) AS attachment_effective_date, format_date("%m/%d/%Y",RLT_CV.VRSN_END_DTE) AS attachment_term_date, 1+(RLT_CV.MARKUP_FCTR_PCT/100) AS percent_1, 1+(RLT_CV.ADDL_MARKUP_PCT/100) AS percent_2, RLT_CV.CNTRCT_RANK_PRTY_NUM AS group_number, FORMAT_DATETIME("%m/%d/%Y",current_datetime())||' 00:00:00' AS record_effective_date FROM `PROJECT_ID.VW_PHM_CONFDIM_CONTRACT.BUYING_GROUP_CUSTOMER_RLT_CV` RLT_CV  JOIN `PROJECT_ID.VW_PHM_CONFDIM_CUSTOMER.CUSTOMER_CODE_CV` CUST_CODE ON  CUST_CODE.CUSTOMER_NUM = RLT_CV.CUSTOMER_NUM AND CUST_CODE.CUSTOMER_NUM = RLT_CV.CUSTOMER_NUM AND CUST_CODE.SALE_ORG_ID = RLT_CV.SALE_ORG_ID AND CUST_CODE.DIST_CHNL_ID = RLT_CV.DIST_CHNL_ID AND CUST_CODE.DIV_ID = RLT_CV.DIV_ID JOIN `PROJECT_ID.VW_PHM_CONFDIM_CUSTOMER.SHIPTO_CUSTOMER_SALES_AREA_RLT_CV` SHIP_TO ON SHIP_TO.SOLDTO_PARTY_CUSTOMER_NUM = RLT_CV.CUSTOMER_NUM AND SHIP_TO.CURR_VRSN_FLG ='Y' AND CUST_CODE.SALE_ORG_ID = SHIP_TO.SALE_ORG_ID AND CUST_CODE.DIST_CHNL_ID = SHIP_TO.DIST_CHNL_ID AND CUST_CODE.DIV_ID = SHIP_TO.DIV_ID JOIN `PROJECT_ID.VW_PHM_CONFDIM_CONTRACT.CONTRACT_BUYING_GROUP_RLT_CV` BUY_GROUP_RLT ON BUY_GROUP_RLT.BUY_GROUP_ID = RLT_CV.BUY_GROUP_ID AND BUY_GROUP_RLT.CURR_VRSN_FLG ='Y' JOIN `PROJECT_ID.VW_PHM_CONFDIM_CONTRACT.CONTRACT_CV` CNT_CV ON CNT_CV.CNTRCT_NUM = BUY_GROUP_RLT.CNTRCT_NUM AND CNT_CV.CURR_VRSN_FLG ='Y' WHERE CUST_CODE.CDE_NUM_ID = '843' AND CUST_CODE.CDE_TYPE_ID ='P' AND CNT_CV.CNTRCT_TYPE_LKP_ID = 'P' AND RLT_CV.VRSN_END_DTE >= CURRENT_DATE AND CUST_CODE.END_DTE >= CURRENT_DATE ;

CREATE OR REPLACE TABLE `PROJECT_ID.D2_PHM_CONFFACT_PRICING.ITEM_BLOCK_TEMP` AS
WITH MAT_BLK_DET AS ( SELECT SOLDTO_CUSTOMER_NUM_ID, SALE_ORG_ID, DIST_CHNL_ID, DIV_ID, BUY_GROUP_ID, '' AS CNTRCT_NUM_ID, MTRL_NUM_ID, VRSN_START_DTE, VRSN_END_DTE, DEL_FLG  FROM PROJECT_ID.VW_PHM_CONFFACT_PRICING.VW_CUSTOMER_BUY_GRP_MTRL_BLOCK_VF MTRL_BLK_BUY_GROUP WHERE MTRL_BLK_BUY_GROUP.CURR_VRSN_FLG ='Y' AND MTRL_BLK_BUY_GROUP.VRSN_END_DTE >= CURRENT_DATE UNION ALL  SELECT SOLDTO_CUSTOMER_NUM_ID, SALE_ORG_ID, DIST_CHNL_ID, DIV_ID, CNT_BYT_GRP_RLT.BUY_GROUP_ID AS BUY_GROUP_ID, CNTRCT_NUM_ID, MTRL_NUM_ID, MTRL_BLK_CNT_NUM.VRSN_START_DTE,MTRL_BLK_CNT_NUM.VRSN_END_DTE,MTRL_BLK_CNT_NUM.DEL_FLG   FROM PROJECT_ID.VW_PHM_CONFFACT_PRICING.VW_CUSTOMER_CNTRCT_MTRL_BLOCK_VF MTRL_BLK_CNT_NUM  JOIN `PROJECT_ID.VW_PHM_CONFDIM_CONTRACT.CONTRACT_BUYING_GROUP_RLT_CV` CNT_BYT_GRP_RLT ON MTRL_BLK_CNT_NUM.CNTRCT_NUM_ID = CNT_BYT_GRP_RLT.CNTRCT_NUM AND CNT_BYT_GRP_RLT.CURR_VRSN_FLG='Y' WHERE MTRL_BLK_CNT_NUM.CURR_VRSN_FLG ='Y' AND MTRL_BLK_CNT_NUM.VRSN_END_DTE >= CURRENT_DATE AND CNT_BYT_GRP_RLT.VRSN_END_DTE >= CURRENT_DATE )  SELECT DISTINCT RIGHT(SHIP_TO.DLVR_PLANT_ID,3) AS division_number, SHIP_TO.CUSTOMER_NUM AS ship_to_customer_number, MAT_BLK_DET.BUY_GROUP_ID AS group_number, ltrim(MAT_BLK_DET.MTRL_NUM_ID,'0') AS corporate_item_number, CASE WHEN MAT_BLK_DET.VRSN_END_DTE >= CURRENT_DATE AND (MAT_BLK_DET.DEL_FLG = 'N' OR MAT_BLK_DET.DEL_FLG IS NULL) THEN 'A' ELSE 'I' END  AS relationship_status, FORMAT_DATETIME("%m/%d/%Y",MAT_BLK_DET.VRSN_START_DTE) AS relationship_effective_date, FORMAT_DATETIME("%m/%d/%Y",current_datetime())||' 00:00:00' AS record_effective_date, MAT_BLK_DET.CNTRCT_NUM_ID AS Contract_Number FROM `PROJECT_ID.VW_PHM_CONFDIM_CUSTOMER.SHIPTO_CUSTOMER_SALES_AREA_RLT_CV` SHIP_TO JOIN MAT_BLK_DET ON SHIP_TO.SOLDTO_PARTY_CUSTOMER_NUM = MAT_BLK_DET.SOLDTO_CUSTOMER_NUM_ID AND SHIP_TO.CURR_VRSN_FLG ='Y' AND MAT_BLK_DET.SALE_ORG_ID = SHIP_TO.SALE_ORG_ID AND MAT_BLK_DET.DIST_CHNL_ID = SHIP_TO.DIST_CHNL_ID AND MAT_BLK_DET.DIV_ID = SHIP_TO.DIV_ID JOIN `PROJECT_ID.VW_PHM_CONFDIM_CUSTOMER.CUSTOMER_CODE_CV` CUST_CODE ON  CUST_CODE.CUSTOMER_NUM = SHIP_TO.CUSTOMER_NUM AND CUST_CODE.SALE_ORG_ID = SHIP_TO.SALE_ORG_ID AND CUST_CODE.DIST_CHNL_ID = SHIP_TO.DIST_CHNL_ID AND CUST_CODE.DIV_ID = SHIP_TO.DIV_ID WHERE CUST_CODE.CDE_NUM_ID = '843' AND CUST_CODE.CDE_TYPE_ID ='P' AND CUST_CODE.END_DTE >= CURRENT_DATE ;

CREATE OR REPLACE TABLE `PROJECT_ID.D2_PHM_CONFFACT_PRICING.VENDER_BLOCK_TEMP` AS
WITH VEND_BLK_DET AS ( SELECT SOLDTO_CUSTOMER_NUM_ID, SALE_ORG_ID, DIST_CHNL_ID, DIV_ID, BUY_GROUP_NUM_ID, '' AS CNTRCT_NUM_ID, VENDOR_NUM_ID, VRSN_START_DTE, VRSN_END_DTE, DEL_FLG  FROM  PROJECT_ID.VW_PHM_CONFFACT_PRICING.VW_CUSTOMER_BUY_GRP_SUPPLIER_BLOCK_VF VEND_BLK_BUY_GROUP WHERE VEND_BLK_BUY_GROUP.CURR_VRSN_FLG ='Y' AND VEND_BLK_BUY_GROUP.VRSN_END_DTE >= CURRENT_DATE UNION ALL  SELECT SOLDTO_CUSTOMER_NUM_ID, SALE_ORG_ID, DIST_CHNL_ID, DIV_ID, CNT_BYT_GRP_RLT.BUY_GROUP_ID AS BUY_GROUP_NUM_ID, CNTRCT_NUM_ID, VENDOR_NUM_ID, VEDN_BLK_CNT_NUM.VRSN_START_DTE, VEDN_BLK_CNT_NUM.VRSN_END_DTE, VEDN_BLK_CNT_NUM.DEL_FLG  FROM PROJECT_ID.VW_PHM_CONFFACT_PRICING.VW_CUSTOMER_CNTRCT_SUPPLIER_BLOCK_VF VEDN_BLK_CNT_NUM  JOIN `PROJECT_ID.VW_PHM_CONFDIM_CONTRACT.CONTRACT_BUYING_GROUP_RLT_CV` CNT_BYT_GRP_RLT ON VEDN_BLK_CNT_NUM.CNTRCT_NUM_ID = CNT_BYT_GRP_RLT.CNTRCT_NUM AND CNT_BYT_GRP_RLT.CURR_VRSN_FLG='Y' WHERE VEDN_BLK_CNT_NUM.CURR_VRSN_FLG ='Y' AND VEDN_BLK_CNT_NUM.VRSN_END_DTE >= CURRENT_DATE AND CNT_BYT_GRP_RLT.VRSN_END_DTE >= CURRENT_DATE )  SELECT DISTINCT RIGHT(SHIP_TO.DLVR_PLANT_ID,3) AS division_number, SHIP_TO.CUSTOMER_NUM AS ship_to_customer_number, VEND_BLK_DET.BUY_GROUP_NUM_ID AS group_number, ltrim(VEND_BLK_DET.VENDOR_NUM_ID,'0') AS vendor_number, CASE WHEN VEND_BLK_DET.VRSN_END_DTE >= CURRENT_DATE AND (VEND_BLK_DET.DEL_FLG = 'N' OR VEND_BLK_DET.DEL_FLG IS NULL) THEN 'A' ELSE 'I' END  AS relationship_status, format_date("%m/%d/%Y",VEND_BLK_DET.VRSN_START_DTE) AS relationship_effective_date, FORMAT_DATETIME("%m/%d/%Y",current_datetime())||' 00:00:00' AS record_effective_date, VEND_BLK_DET.CNTRCT_NUM_ID AS Contract_Number FROM `PROJECT_ID.VW_PHM_CONFDIM_CUSTOMER.SHIPTO_CUSTOMER_SALES_AREA_RLT_CV` SHIP_TO JOIN VEND_BLK_DET ON SHIP_TO.SOLDTO_PARTY_CUSTOMER_NUM = VEND_BLK_DET.SOLDTO_CUSTOMER_NUM_ID AND SHIP_TO.CURR_VRSN_FLG ='Y' AND VEND_BLK_DET.SALE_ORG_ID = SHIP_TO.SALE_ORG_ID AND VEND_BLK_DET.DIST_CHNL_ID = SHIP_TO.DIST_CHNL_ID AND VEND_BLK_DET.DIV_ID = SHIP_TO.DIV_ID JOIN `PROJECT_ID.VW_PHM_CONFDIM_CUSTOMER.CUSTOMER_CODE_CV` CUST_CODE ON  CUST_CODE.CUSTOMER_NUM = SHIP_TO.CUSTOMER_NUM AND CUST_CODE.SALE_ORG_ID = SHIP_TO.SALE_ORG_ID AND CUST_CODE.DIST_CHNL_ID = SHIP_TO.DIST_CHNL_ID AND CUST_CODE.DIV_ID = SHIP_TO.DIV_ID WHERE CUST_CODE.CDE_NUM_ID = '843' AND CUST_CODE.CDE_TYPE_ID ='P' AND CUST_CODE.END_DTE >= CURRENT_DATE ;

CREATE OR REPLACE TABLE `PROJECT_ID.D2_PHM_CONFFACT_PRICING.WAC_DATA_TEMP` AS
SELECT DISTINCT ifnull(right(concat(repeat('0',11),MAT_CV.CALC_NDC_ID),11), repeat('0',11)) AS national_drug_code, CASE WHEN PRI_VF.RFRNC_PRICE_AMT IS NULL THEN 0.00 ELSE PRI_VF.RFRNC_PRICE_AMT END AS new_awp, CASE WHEN PRI_VF.CALC_CORP_NIFO_AMT IS NULL THEN 0.00 ELSE PRI_VF.CALC_CORP_NIFO_AMT END new_corp_nifo, '0.00' AS new_cost_plus, CASE WHEN PRI_VF.DISC_WAC_AMT IS NULL AND PRI_VF.WAC_AMT IS NULL THEN 0.00 ELSE  CASE WHEN PRICE_USAGE_LKP_ID = 'ZDIS' THEN PRI_VF.DISC_WAC_AMT ELSE PRI_VF.WAC_AMT END END AS new_base_cost, CASE WHEN PRI_VF.EXCISE_TAX_AMT IS NULL THEN 0.00 ELSE PRI_VF.EXCISE_TAX_AMT END AS new_additional_charge, CASE WHEN PRI_VF.VRSN_START_DTE IS NULL THEN '01/01/1901' ELSE format_date("%m/%d/%Y",PRI_VF.VRSN_START_DTE) END AS effective_date, MAT_CV.XPLNT_MTRL_STAT_LKP_ID AS activity_status_code, MAT_CV.XPLNT_MTRL_STAT_DESC_TXT AS activity_description, CASE WHEN MAT_CV.MTRL_GROUP_LKP_ID= 'ZGENERIC' THEN 1 WHEN MAT_CV.MTRL_GROUP_LKP_ID = 'ZBRAND' THEN 2 ELSE 0 END AS generic_indicator_code, TRIM(MAT_CV.CALC_CARD_SBST_KEY_ID) AS cardinal_substitution_key, CASE WHEN TRIM(MAT_CV.CARD_GCN_SEQ_NUM) ='' THEN '' ELSE right(concat(repeat('0',6),MAT_CV.CARD_GCN_SEQ_NUM),6) END AS cardinal_gcn_code, ltrim(MAT_CV.MTRL_NUM,'0') AS corporate_item_number, TRIM(MAT_CV.HAM_FINEST_CLASS_LKP_ID) AS hamacher_department_number, TRIM(MAT_CV.HAM_FINEST_CLASS_DESC_TXT) AS hamacher_description, TRIM(MAT_CV.FORM_LKP_ID) AS form_id, TRIM(MAT_CV.FORM_DESC_TXT) AS form_description, TRIM(MAT_CV.FDB_MULTI_SRC_IND_ID) AS multi_source_indicator_code, MAT_CV.CALC_PACK_QTY AS package_quantity, 0 AS Accunet_Size, MAT_CV.BILL_UOM_ID AS package_size_unit, TRIM(MAT_CV.BILL_UOM_DESC_TXT) AS package_size_description, TRIM(MAT_CV.BASE_UOM_LKP_ID) AS unit_code, TRIM(MAT_CV.BASE_UOM_DESC_TXT) AS Unit_Code_Desc, 0 AS Private_Label_Code, '' AS Private_Label_Desc, MAT_CV.SIZE_DIM_TXT AS Package_Size, TRIM(MAT_CV.STRGTH_TXT) AS Strength, 0 AS Total_Quantity, ifnull(TRIM(MAT_CV.TRADE_NAM),'') AS Trade_Name, TRIM(MAT_CV.PACK_IND_LKP_ID) AS Unit_Dose, ifnull(TRIM(MAT_CV.PACK_IND_DESC_TXT),'') AS Unit_Dose_Desc, ifnull(TRIM(MED.DRUG_GROUP_CDE),'') AS DRUG_GROUP_ID, ifnull(TRIM(MED.DRUG_GROUP_DESCRIPTION),'') AS DESC_TXT, CASE WHEN ltrim(TRIM(MAT_CV.SUPPLIER_NUM),'0') = '' THEN '0' ELSE ltrim(MAT_CV.SUPPLIER_NUM,'0') END AS Vendor_Number, ifnull(TRIM(MAT_CV.SUPPLIER_NAM),'') AS Vendor_Name, ifnull(TRIM(MAT_CV.CALC_DEA_SCHED_ID),'00') AS DEA_Schedule_Number, MAT_CV.DEA_SCHED_NUM_DESC_TXT AS deaSchedDesc, 0 AS Item_Type_Code, '' AS Item_Type_Code_Description, 0 AS Department_Code, '' AS department_description, MAT_CV.STICKER_QTY AS caseQty, ifnull(MAT_CV.CARD_AHFS_CDE ,'')AS ahfs_description, ifnull(FD_MAS.RT,'') AS route_administration, 1 AS minPackQty, MAT_CV.GEN_NAM_TXT AS generic_name, ifnull(FD_MAS.OBC,'') AS orange_book_code, ifnull(FD_MAS.GCN_SEQNO,'') AS hicl_seq_number, '' AS hicl , MAT_CV.CALC_ACCUNET_QTY AS totalCaseQty, FORMAT_DATETIME("%m/%d/%Y",current_datetime())||' 00:00:00' AS recordDate, ifnull(MAT_CV.CALC_RX_FLG,'N') AS rxIndicator, CASE WHEN PLT_RLT_CV.PLANT_ID  IS NULL THEN 'N' ELSE 'Y' END AS prItem, ifnull(MAT_CV.MTRL_TYPE_LKP_ID,'') AS materialType, ifnull(MAT_CV.MTRL_GROUP_LKP_ID,'') AS materialGroup, ifnull(MAT_CV.MTRL_GROUP_PACK_MTRL_LKP_ID,'') AS materialPackageGroup, ifnull(MAT_CV.ITEM_CTGRY_GROUP_LKP_ID,'') AS materialGroupCategory, CASE WHEN vizientItem.MTRL_NUM_ID IS NULL THEN 'N' ELSE 'Y' END AS VIZIENT_ITM, CASE WHEN PREMIERPRORX_ITM.MTRL_NUM_ID IS NULL THEN 'N' ELSE 'Y' END AS PREMIERPRORX_ITM FROM `PROJECT_ID.VW_PHM_CONFDIM_MATERIAL.MATERIAL_CV` MAT_CV LEFT OUTER JOIN `PROJECT_ID.VW_PHM_CONFDIM_MATERIAL.MEDISPAN_MASTER_CV` MED ON ltrim(MAT_CV.CALC_NDC_ID,'0') = ltrim(MED.NDC_UPC_HRI_ID,'0') LEFT OUTER JOIN `PROJECT_ID.VW_PHM_CONFDIM_MATERIAL.FDB_MASTER_CV` FD_MAS ON ltrim(MAT_CV.CALC_NDC_ID,'0') = ltrim(FD_MAS.NDC,'0') LEFT OUTER JOIN `PROJECT_ID.VW_PHM_CONFDIM_MATERIAL.MATERIAL_PRICING_VF` PRI_VF ON MAT_CV.MTRL_NUM = PRI_VF.MTRL_NUM AND PRI_VF.CURR_VRSN_FLG = 'Y' LEFT OUTER JOIN `PROJECT_ID.VW_PHM_CONFDIM_MATERIAL.MATERIAL_PLANT_RLT_CV` PLT_RLT_CV ON MAT_CV.MTRL_NUM = PLT_RLT_CV.MTRL_NUM AND PLT_RLT_CV.PLANT_ID = 'P066'  LEFT OUTER JOIN `PROJECT_ID.VW_PHM_CONFDIM_MATERIAL.VW_LOCAL_INCL_EXCL_CUSTLIST_MTRL` vizientItem ON MAT_CV.MTRL_NUM = vizientItem.MTRL_NUM_ID AND vizientItem.CURR_VRSN_FLG = 'Y'  AND vizientItem.CNTRCT_NUM_ID = '0000300209' LEFT OUTER JOIN `PROJECT_ID.VW_PHM_CONFDIM_MATERIAL.VW_LOCAL_INCL_EXCL_CUSTLIST_MTRL` PREMIERPRORX_ITM ON MAT_CV.MTRL_NUM = PREMIERPRORX_ITM.MTRL_NUM_ID AND PREMIERPRORX_ITM.CURR_VRSN_FLG = 'Y' AND PREMIERPRORX_ITM.CNTRCT_NUM_ID = '0000300223' WHERE  MAT_CV.CURR_VRSN_FLG ='Y' AND MAT_CV.MTRL_TYPE_LKP_ID LIKE 'Z%' AND MAT_CV.MTRL_TYPE_LKP_ID <> 'ZREB' ;

CREATE OR REPLACE TABLE `PROJECT_ID.D2_PHM_CONFFACT_PRICING.GRP_FUTURE_PRICE_TEMP` AS
SELECT DISTINCT BUY_GP_RLT.BUY_GROUP_ID AS group_number, BUY_GP.BUY_GROUP_DESC_TXT AS group_name, CNT_CV.CNTRCT_TYPE_LKP_ID AS group_type, CNT_CV.CNTRCT_TYPE_DESC_TXT AS cntrct_desc, GRP_REF.CTGREF  AS group_reference, CNT_CV.CNTRCT_NUM AS contract_number, extract(YEAR FROM CNT_CV.CNTRCT_START_DTE) AS contract_effective_year, extract(MONTH FROM CNT_CV.CNTRCT_START_DTE) AS contract_effective_month, extract(DAY FROM CNT_CV.CNTRCT_START_DTE) AS contract_effective_date, extract(YEAR FROM CNT_CV.CNTRCT_END_DTE) AS contract_term_year, extract(MONTH FROM CNT_CV.CNTRCT_END_DTE) AS contract_term_month, extract(DAY FROM CNT_CV.CNTRCT_END_DTE) AS contract_term_date, ltrim(SUP_CV.SUPPLIER_NUM,'0') AS vendor_number, SUP_CV.SUPPLIER_NAM AS vendor_name, ltrim(SUP_CV.PARENT_SUPPLIER_NUM,'0') AS parent_vendor_number, SUP_CV.SUPPLIER_NAM AS parent_vendor_name, CASE  WHEN MAT_DE_V.MTRL_NUM IS NULL THEN 'A' WHEN MAT_DE_V.VRSN_END_DTE = PEND_MAT_DE_VF.VRSN_END_DTE THEN 'U' WHEN MAT_DE_V.VRSN_END_DTE > PEND_MAT_DE_VF.VRSN_END_DTE THEN 'D' ELSE 'U'  END AS chg_cde, extract(YEAR FROM PEND_MAT_DE_VF.CREATE_ON_DTE) AS change_effective_year, extract(MONTH FROM PEND_MAT_DE_VF.CREATE_ON_DTE) AS change_effective_month, extract(DAY FROM PEND_MAT_DE_VF.CREATE_ON_DTE) AS change_effective_date, SAFE_CAST(CONCAT(CASE WHEN extract(HOUR FROM PEND_MAT_DE_VF.CREATE_ON_TIM) =0 THEN '' ELSE SAFE_CAST(extract(HOUR FROM PEND_MAT_DE_VF.CREATE_ON_TIM) AS STRING) END, extract(MINUTE FROM PEND_MAT_DE_VF.CREATE_ON_TIM), CASE WHEN extract(SECOND FROM PEND_MAT_DE_VF.CREATE_ON_TIM) =0 THEN '' ELSE SAFE_CAST(extract(SECOND FROM PEND_MAT_DE_VF.CREATE_ON_TIM) AS STRING) END) AS INT) AS chg_time, ltrim(PEND_MAT_DE_VF.MTRL_NUM,'0') AS corporate_item_number, MAT_CV.MTRL_DESC_TXT AS corporate_description, ifnull(right(concat(repeat('0',11),MAT_CV.CALC_NDC_ID),11), repeat('0',11)) AS national_drug_code, PEND_MAT_DE_VF.CALC_CNTRCT_COST_AMT AS contract_cost, PEND_MAT_DE_VF.CALC_SELL_PRICE_AMT AS contract_sell, GRP_REF.parent_affiliation_id AS parent_affiliation_id, GRP_REF.parent_affiliation AS parent_affiliation, CASE WHEN MAT_DE_V.CGBK_RFRNC_NUM_ID ='' THEN CNT_CV.CGBK_RFRNC_NUM_ID ELSE MAT_DE_V.CGBK_RFRNC_NUM_ID END  AS vendor_reference, extract(YEAR FROM PEND_MAT_DE_VF.VRSN_START_DTE) AS item_effective_year, extract(MONTH FROM PEND_MAT_DE_VF.VRSN_START_DTE) AS item_effective_month, extract(DAY FROM PEND_MAT_DE_VF.VRSN_START_DTE) AS item_effective_date, FORMAT_DATETIME("%m/%d/%Y",current_datetime())||' 00:00:00' AS record_effective_date FROM `PROJECT_ID.VW_PHM_CONFDIM_CONTRACT.CONTRACT_MTRL_DETAIL_PENDING_VF` PEND_MAT_DE_VF  LEFT OUTER JOIN `PROJECT_ID.VW_PHM_CONFDIM_CONTRACT.CONTRACT_MATERIAL_DETAIL_VF` MAT_DE_V ON MAT_DE_V.CNTRCT_NUM = PEND_MAT_DE_VF.CNTRCT_NUM AND MAT_DE_V.MTRL_NUM = PEND_MAT_DE_VF.MTRL_NUM AND MAT_DE_V.CURR_VRSN_FLG = 'Y' JOIN `PROJECT_ID.VW_PHM_CONFDIM_CONTRACT.CONTRACT_CV` CNT_CV ON PEND_MAT_DE_VF.CNTRCT_NUM=CNT_CV.CNTRCT_NUM AND CNT_CV.CURR_VRSN_FLG ='Y' JOIN `PROJECT_ID.VW_PHM_CONFDIM_MATERIAL.MATERIAL_CV` MAT_CV ON MAT_CV.MTRL_NUM=PEND_MAT_DE_VF.MTRL_NUM  AND MAT_CV.CURR_VRSN_FLG ='Y'    JOIN `PROJECT_ID.VW_PHM_CONFDIM_CONTRACT.CONTRACT_BUYING_GROUP_RLT_CV` BUY_GP_RLT ON BUY_GP_RLT.CNTRCT_NUM=CNT_CV.CNTRCT_NUM  AND BUY_GP_RLT.CURR_VRSN_FLG ='Y' JOIN `PROJECT_ID.VW_PHM_CONFDIM_CONTRACT.BUYING_GROUP_CV` BUY_GP ON BUY_GP.BUY_GROUP_ID=BUY_GP_RLT.BUY_GROUP_ID AND BUY_GP.CURR_VRSN_FLG ='Y' JOIN `PROJECT_ID.VW_PHM_CONFDIM_SUPPLIER.SUPPLIER_CV` SUP_CV ON SUP_CV.SUPPLIER_NUM=MAT_CV.SUPPLIER_NUM AND SUP_CV.CURR_VRSN_FLG ='Y'  LEFT OUTER JOIN ( SELECT  DISTINCT  PEND_MAT_DE_VF.CNTRCT_NUM,  CASE WHEN C.GPO_GROUP_ID <> '' THEN G.CCA_GROUP_RFRNC_ID ELSE H.CCA_GROUP_RFRNC_ID END CTGREF, D.BUY_GROUP_ID, E.RFRNC_BUY_GROUP_ORG_NUM AS parent_affiliation_id, E. RFRNC_BUY_GROUP_ORG_NUM AS parent_affiliation FROM `PROJECT_ID.VW_PHM_CONFDIM_CONTRACT.CONTRACT_MTRL_DETAIL_PENDING_VF` PEND_MAT_DE_VF  JOIN `PROJECT_ID.VW_PHM_CONFDIM_CONTRACT.CONTRACT_CV` C ON c.CNTRCT_NUM = PEND_MAT_DE_VF.CNTRCT_NUM LEFT OUTER JOIN `PROJECT_ID.VW_PHM_CONFDIM_CONTRACT.CONTRACT_BUYING_GROUP_RLT_CV` B ON B.CNTRCT_NUM=C.CNTRCT_NUM AND C.CURR_VRSN_FLG='Y' LEFT OUTER JOIN `PROJECT_ID.VW_PHM_CONFDIM_CONTRACT.BUYING_GROUP_CV` D ON D.BUY_GROUP_ID = B.BUY_GROUP_ID AND D.CURR_VRSN_FLG ='Y' LEFT OUTER JOIN `PROJECT_ID.VW_PHM_CONFDIM_CONTRACT.BUYING_GROUP_ORGANIZATION_CV` E ON E.BUY_GROUP_ORG_NUM =b.BUY_GROUP_ORG_NUM AND E.CURR_VRSN_FLG ='Y' LEFT OUTER JOIN `PROJECT_ID.VW_PHM_CONFDIM_CONTRACT.BUYING_GROUP_ORGANIZATION_CV` H ON H.BUY_GROUP_ORG_NUM =E.RFRNC_BUY_GROUP_ORG_NUM AND H.CURR_VRSN_FLG ='Y' LEFT OUTER JOIN `PROJECT_ID.VW_PHM_CONFDIM_CONTRACT.BUYING_GROUP_ORGANIZATION_CV` G ON G.BUY_GROUP_ORG_NUM =C.GPO_GROUP_ID AND G.CURR_VRSN_FLG ='Y' ) GRP_REF ON GRP_REF.CNTRCT_NUM = CNT_CV.CNTRCT_NUM AND GRP_REF.BUY_GROUP_ID = BUY_GP_RLT.BUY_GROUP_ID JOIN  ( SELECT DISTINCT RLT_CV.BUY_GROUP_ID  FROM `PROJECT_ID.VW_PHM_CONFDIM_CONTRACT.BUYING_GROUP_CUSTOMER_RLT_CV` RLT_CV  JOIN `PROJECT_ID.VW_PHM_CONFDIM_CUSTOMER.CUSTOMER_CODE_CV` CUST_CODE ON CUST_CODE.CUSTOMER_NUM = RLT_CV.CUSTOMER_NUM AND CUST_CODE.SALE_ORG_ID = RLT_CV.SALE_ORG_ID AND CUST_CODE.DIST_CHNL_ID = RLT_CV.DIST_CHNL_ID AND CUST_CODE.DIV_ID = RLT_CV.DIV_ID JOIN `PROJECT_ID.VW_PHM_CONFDIM_CUSTOMER.SHIPTO_CUSTOMER_SALES_AREA_RLT_CV` SHIP_TO ON SHIP_TO.SOLDTO_PARTY_CUSTOMER_NUM = RLT_CV.CUSTOMER_NUM AND SHIP_TO.CURR_VRSN_FLG ='Y'  AND CUST_CODE.SALE_ORG_ID = SHIP_TO.SALE_ORG_ID AND CUST_CODE.DIST_CHNL_ID = SHIP_TO.DIST_CHNL_ID AND CUST_CODE.DIV_ID = SHIP_TO.DIV_ID JOIN `PROJECT_ID.VW_PHM_CONFDIM_CONTRACT.CONTRACT_BUYING_GROUP_RLT_CV` BUY_GROUP_RLT ON BUY_GROUP_RLT.BUY_GROUP_ID = RLT_CV.BUY_GROUP_ID AND BUY_GROUP_RLT.CURR_VRSN_FLG ='Y' JOIN `PROJECT_ID.VW_PHM_CONFDIM_CONTRACT.CONTRACT_CV` CNT_CV ON CNT_CV.CNTRCT_NUM = BUY_GROUP_RLT.CNTRCT_NUM AND CNT_CV.CURR_VRSN_FLG ='Y'  WHERE CUST_CODE.CDE_NUM_ID = '843' AND CUST_CODE.CDE_TYPE_ID ='P' AND CNT_CV.CNTRCT_TYPE_LKP_ID NOT IN ('P','T') AND RLT_CV.CURR_VRSN_FLG='Y'   AND CUST_CODE.END_DTE >= CURRENT_DATE) BUY_GRP_LIST ON BUY_GRP_LIST.BUY_GROUP_ID = BUY_GP.BUY_GROUP_ID WHERE  PEND_MAT_DE_VF.CURR_VRSN_FLG ='Y' AND CNT_CV.CNTRCT_TYPE_LKP_ID NOT IN ('P','T') AND PEND_MAT_DE_VF.VRSN_START_DTE >= CURRENT_DATE AND PEND_MAT_DE_VF.UPDATE_IND_ID <> 'D' ;

CREATE OR REPLACE TABLE `PROJECT_ID.D2_PHM_CONFFACT_PRICING.CHPC_MBR_ACCESS_TEMP` AS
SELECT  DISTINCT SHIP_TO.AFLTN_LEVEL1_CUSTOMER_NUM AS root_affiliation_number, SHIP_TO.AFLTN_LEVEL1_CUSTOMER_NAM AS root_affiliation_name, SHIP_TO.AFLTN_LEVEL3_CUSTOMER_NUM AS affiliation_number, SHIP_TO.AFLTN_LEVEL3_CUSTOMER_NAM AS affiliation_name, RIGHT(SHIP_TO.DLVR_PLANT_ID,3) AS group_id, CUST_RLT_CV.CUSTOMER_NUM AS ship_to_customer_number, CUST.CUSTOMER_NAM AS ship_to_customer_name, CUST_RLT_CV.BUY_GROUP_ID AS group_number, BUY_CV.BUY_GROUP_DESC_TXT AS group_name, CUST_RLT_CV.CNTRCT_RANK_PRTY_NUM AS group_priority_ranking, CUST_RLT_CV.CNTRCT_RANK_PREFER_NUM AS secondary_priority_ranking, CASE WHEN CUST.DEL_IND_FLG ='X' THEN 'I' ELSE 'A' END account_status_flag, CASE  WHEN CODE_CV.END_DTE < CURRENT_DATE THEN 'I' WHEN CODE_CV.START_DTE <= CURRENT_DATE AND CODE_CV.END_DTE >= CURRENT_DATE THEN 'A' WHEN CODE_CV.START_DTE > CURRENT_DATE THEN 'F' END relationship_status_flag, format_date("%m/%d/%Y",CUST_RLT_CV.VRSN_START_DTE) AS relationship_effective_date, 0 AS edi_type_code, FORMAT_DATETIME("%m/%d/%Y",current_datetime())||' 00:00:00'  AS record_effective_date, SHIP_TO.AFLTN_LEVEL2_CUSTOMER_NUM AS A2_root_affiliation_number, SHIP_TO.AFLTN_LEVEL2_CUSTOMER_NAM AS A2_root_affiliation_name FROM `PROJECT_ID.VW_PHM_CONFDIM_CONTRACT.BUYING_GROUP_CUSTOMER_RLT_CV` CUST_RLT_CV  JOIN `PROJECT_ID.VW_PHM_CONFDIM_CUSTOMER.SHIPTO_CUSTOMER_SALES_AREA_RLT_CV` SHIP_TO ON SHIP_TO.SOLDTO_PARTY_CUSTOMER_NUM = CUST_RLT_CV.CUSTOMER_NUM AND SHIP_TO.CURR_VRSN_FLG ='Y' JOIN  `PROJECT_ID.VW_PHM_CONFDIM_CUSTOMER.CUSTOMER_CODE_CV` CODE_CV ON CODE_CV.CUSTOMER_NUM=SHIP_TO.CUSTOMER_NUM  AND CODE_CV.SALE_ORG_ID = SHIP_TO.SALE_ORG_ID AND CODE_CV.DIST_CHNL_ID = SHIP_TO.DIST_CHNL_ID AND CODE_CV.DIV_ID = SHIP_TO.DIV_ID JOIN `PROJECT_ID.VW_PHM_CONFDIM_CUSTOMER.CUSTOMER_CV` CUST ON CUST.CUSTOMER_NUM=CUST_RLT_CV.CUSTOMER_NUM AND CUST.CURR_VRSN_FLG='Y'  AND CODE_CV.SALE_ORG_ID = CUST_RLT_CV.SALE_ORG_ID AND CODE_CV.DIST_CHNL_ID = CUST_RLT_CV.DIST_CHNL_ID AND CODE_CV.DIV_ID = CUST_RLT_CV.DIV_ID JOIN `PROJECT_ID.VW_PHM_CONFDIM_CONTRACT.BUYING_GROUP_CV` BUY_CV ON BUY_CV.BUY_GROUP_ID=CUST_RLT_CV.BUY_GROUP_ID AND BUY_CV.CURR_VRSN_FLG='Y' AND BUY_CV.CURR_VRSN_FLG ='Y' WHERE  CUST_RLT_CV.CURR_VRSN_FLG ='Y' AND CODE_CV.CDE_NUM_ID = '843' AND CODE_CV.CDE_TYPE_ID ='P'  AND CUST_RLT_CV.VRSN_END_DTE >= CURRENT_DATE AND BUY_CV.VRSN_END_DTE >= CURRENT_DATE AND CODE_CV.END_DTE >= CURRENT_DATE AND CUST.DEL_IND_FLG = '' ;

CREATE OR REPLACE TABLE `PROJECT_ID.D2_PHM_CONFFACT_PRICING.GRP_CURPRC_TEMP` AS
SELECT DISTINCT BUY_GP_RLT.BUY_GROUP_ID AS group_number, BUY_GP.BUY_GROUP_DESC_TXT AS group_name, CNT_CV.CNTRCT_TYPE_LKP_ID AS group_type_id, CNT_CV.CNTRCT_TYPE_DESC_TXT AS contract_description, GRP_REF.CTGREF  AS group_reference, CNT_CV.CNTRCT_NUM AS contract_number, extract(YEAR FROM CNT_CV.CNTRCT_START_DTE) AS contract_effective_year, extract(MONTH FROM CNT_CV.CNTRCT_START_DTE) AS contract_effective_month, extract(DAY FROM CNT_CV.CNTRCT_START_DTE) AS contract_effective_date, extract(YEAR FROM CNT_CV.CNTRCT_END_DTE) AS contract_term_year, extract(MONTH FROM CNT_CV.CNTRCT_END_DTE) AS contract_term_month, extract(DAY FROM CNT_CV.CNTRCT_END_DTE) AS contract_term_date, ltrim(SUP_CV.SUPPLIER_NUM,'0') AS vendor_number, SUP_CV.SUPPLIER_NAM AS vendor_name, ltrim(SUP_CV.PARENT_SUPPLIER_NUM,'0') AS parent_vendor_number, SUP_CV.PARENT_SUPPLIER_NAM AS parent_vendor_name, LTRIM(MAT_DE_VF.MTRL_NUM,'0') AS corporate_item_number, MAT_CV.MTRL_DESC_TXT AS corporate_description, ifnull(right(concat(repeat('0',11),MAT_CV.CALC_NDC_ID),11), repeat('0',11)) AS national_drug_code, MAT_DE_VF.CALC_CNTRCT_COST_PLUS_EXCISE_TAX_AMT AS contract_cost, MAT_DE_VF.CALC_SELL_PRICE_AMT AS contract_sell, GRP_REF.parent_affiliation_id AS parent_affiliation_id, GRP_REF.parent_affiliation AS parent_affiliation, CASE WHEN MAT_DE_VF.CGBK_RFRNC_NUM_ID ='' THEN CNT_CV.CGBK_RFRNC_NUM_ID ELSE MAT_DE_VF.CGBK_RFRNC_NUM_ID END  AS vendor_reference, format_date("%m/%d/%Y",MAT_DE_VF.VRSN_START_DTE ) AS item_effective_date, FORMAT_DATETIME("%m/%d/%Y",current_datetime())||' 00:00:00' AS record_effective_date FROM `PROJECT_ID.VW_PHM_CONFDIM_CONTRACT.CONTRACT_MATERIAL_DETAIL_VF` MAT_DE_VF  JOIN `PROJECT_ID.VW_PHM_CONFDIM_CONTRACT.CONTRACT_CV` CNT_CV ON MAT_DE_VF.CNTRCT_NUM=CNT_CV.CNTRCT_NUM AND CNT_CV.CURR_VRSN_FLG ='Y' JOIN `PROJECT_ID.VW_PHM_CONFDIM_MATERIAL.MATERIAL_CV` MAT_CV ON MAT_CV.MTRL_NUM=MAT_DE_VF.MTRL_NUM  AND MAT_CV.CURR_VRSN_FLG ='Y'    JOIN `PROJECT_ID.VW_PHM_CONFDIM_CONTRACT.CONTRACT_BUYING_GROUP_RLT_CV` BUY_GP_RLT ON BUY_GP_RLT.CNTRCT_NUM=CNT_CV.CNTRCT_NUM  AND BUY_GP_RLT.CURR_VRSN_FLG ='Y' JOIN `PROJECT_ID.VW_PHM_CONFDIM_CONTRACT.BUYING_GROUP_CV` BUY_GP ON BUY_GP.BUY_GROUP_ID=BUY_GP_RLT.BUY_GROUP_ID AND BUY_GP.CURR_VRSN_FLG ='Y' JOIN `PROJECT_ID.VW_PHM_CONFDIM_SUPPLIER.SUPPLIER_CV` SUP_CV ON SUP_CV.SUPPLIER_NUM=MAT_CV.SUPPLIER_NUM AND SUP_CV.CURR_VRSN_FLG ='Y'  LEFT OUTER JOIN ( SELECT  DISTINCT  C.CNTRCT_NUM,  CASE WHEN C.GPO_GROUP_ID <> '' THEN G.CCA_GROUP_RFRNC_ID ELSE H.CCA_GROUP_RFRNC_ID END CTGREF, D.BUY_GROUP_ID, E.RFRNC_BUY_GROUP_ORG_NUM AS parent_affiliation_id, E. RFRNC_BUY_GROUP_ORG_NAM AS parent_affiliation FROM `PROJECT_ID.VW_PHM_CONFDIM_CONTRACT.CONTRACT_CV` C LEFT OUTER JOIN `PROJECT_ID.VW_PHM_CONFDIM_CONTRACT.CONTRACT_BUYING_GROUP_RLT_CV` B ON B.CNTRCT_NUM=C.CNTRCT_NUM AND C.CURR_VRSN_FLG='Y' LEFT OUTER JOIN `PROJECT_ID.VW_PHM_CONFDIM_CONTRACT.BUYING_GROUP_CV` D ON D.BUY_GROUP_ID = B.BUY_GROUP_ID AND D.CURR_VRSN_FLG ='Y' LEFT OUTER JOIN `PROJECT_ID.VW_PHM_CONFDIM_CONTRACT.BUYING_GROUP_ORGANIZATION_CV` E ON E.BUY_GROUP_ORG_NUM =b.BUY_GROUP_ORG_NUM AND E.CURR_VRSN_FLG ='Y' LEFT OUTER JOIN `PROJECT_ID.VW_PHM_CONFDIM_CONTRACT.BUYING_GROUP_ORGANIZATION_CV` H ON H.BUY_GROUP_ORG_NUM =E.RFRNC_BUY_GROUP_ORG_NUM AND H.CURR_VRSN_FLG ='Y' LEFT OUTER JOIN `PROJECT_ID.VW_PHM_CONFDIM_CONTRACT.BUYING_GROUP_ORGANIZATION_CV` G ON G.BUY_GROUP_ORG_NUM =C.GPO_GROUP_ID AND G.CURR_VRSN_FLG ='Y' ) GRP_REF ON GRP_REF.CNTRCT_NUM = CNT_CV.CNTRCT_NUM AND GRP_REF.BUY_GROUP_ID = BUY_GP_RLT.BUY_GROUP_ID JOIN  ( SELECT DISTINCT RLT_CV.BUY_GROUP_ID  FROM `PROJECT_ID.VW_PHM_CONFDIM_CONTRACT.BUYING_GROUP_CUSTOMER_RLT_CV` RLT_CV  JOIN `PROJECT_ID.VW_PHM_CONFDIM_CUSTOMER.CUSTOMER_CODE_CV` CUST_CODE ON CUST_CODE.CUSTOMER_NUM = RLT_CV.CUSTOMER_NUM AND CUST_CODE.SALE_ORG_ID = RLT_CV.SALE_ORG_ID AND CUST_CODE.DIST_CHNL_ID = RLT_CV.DIST_CHNL_ID AND CUST_CODE.DIV_ID = RLT_CV.DIV_ID JOIN `PROJECT_ID.VW_PHM_CONFDIM_CUSTOMER.SHIPTO_CUSTOMER_SALES_AREA_RLT_CV` SHIP_TO ON SHIP_TO.SOLDTO_PARTY_CUSTOMER_NUM = RLT_CV.CUSTOMER_NUM AND SHIP_TO.CURR_VRSN_FLG ='Y'  AND CUST_CODE.SALE_ORG_ID = SHIP_TO.SALE_ORG_ID AND CUST_CODE.DIST_CHNL_ID = SHIP_TO.DIST_CHNL_ID AND CUST_CODE.DIV_ID = SHIP_TO.DIV_ID JOIN `PROJECT_ID.VW_PHM_CONFDIM_CONTRACT.CONTRACT_BUYING_GROUP_RLT_CV` BUY_GROUP_RLT ON BUY_GROUP_RLT.BUY_GROUP_ID = RLT_CV.BUY_GROUP_ID AND BUY_GROUP_RLT.CURR_VRSN_FLG ='Y' JOIN `PROJECT_ID.VW_PHM_CONFDIM_CONTRACT.CONTRACT_CV` CNT_CV ON CNT_CV.CNTRCT_NUM = BUY_GROUP_RLT.CNTRCT_NUM AND CNT_CV.CURR_VRSN_FLG ='Y'  WHERE CUST_CODE.CDE_NUM_ID = '843' AND CUST_CODE.CDE_TYPE_ID ='P' AND CNT_CV.CNTRCT_TYPE_LKP_ID NOT IN ('P','T') AND RLT_CV.CURR_VRSN_FLG='Y'   AND CUST_CODE.END_DTE >= CURRENT_DATE) BUY_GRP_LIST ON BUY_GRP_LIST.BUY_GROUP_ID = BUY_GP.BUY_GROUP_ID WHERE  MAT_DE_VF.CURR_VRSN_FLG ='Y' AND CNT_CV.CNTRCT_TYPE_LKP_ID NOT IN ('P','T') AND CNT_CV.CNTRCT_END_DTE >= CURRENT_DATE ;

CREATE OR REPLACE TABLE `PROJECT_ID.D2_PHM_CONFFACT_PRICING.CHPC_BCKORD_TEMP` AS
SELECT DISTINCT CALC_CARD_SBST_KEY_ID AS cardinal_substitution_key, SUPPLIER_NAM vendor_name, LTRIM(AVAIL_ALERT.MTRL_NUM,'0') AS corporate_item_number, ifnull(right(concat(repeat('0',11),MAT_CV.CALC_NDC_ID),11), repeat('0',11)) AS national_drug_code, MTRL_DESC_TXT AS corporate_description, LTRIM(AVAIL_ALERT.MTRL_NUM,'0') AS AAAITEM, AVAIL_ALERT_CDE AS availability_alert_code, EXPDT_CDE AS external_message_code, AVAIL_ALERT_EXTRNL_MSG_TXT AS external_message, format_date("%m/%d/%Y",EXPCT_DLVRY_DTE) AS expected_delivery_date,  AVAIL_ALERT_INTRNL_MSG_TXT AS internal_message, format_date("%m/%d/%Y",CHG_DTE) AS change_date, CHG_TIM AS change_time, format_date("%m/%d/%Y",ORGNTN_DTE) AS origination_date, EXPDT_CDE_TYPE AS expediting_code_type, FORMAT_DATETIME("%m/%d/%Y",current_datetime())||' 00:00:00' AS record_effective_date FROM `PROJECT_ID.VW_PHM_CONFDIM_MATERIAL.MATERIAL_CV` MAT_CV  JOIN `PROJECT_ID.VW_PHM_CONFFACT_INVENTORY.AVAILABILITY_ALERT_TRNSCT` AVAIL_ALERT ON MAT_CV.MTRL_NUM = AVAIL_ALERT.MTRL_NUM WHERE MAT_CV.CURR_VRSN_FLG = 'Y' AND AVAIL_ALERT.CURR_VRSN_FLG = 'Y' ;

END;